# 全局数据存储白皮书（2026-02-25）

---

## 1) localStorage（浏览器侧）

| 模块 | 键 | 用途 | 生命周期 |
|---|---|---|---|
| 设置中心 | `eva.settings.v1` | 外观、番茄钟、工作区、AI Key、局域网、考研目标等配置 | 长期保留，用户手动重置 |
| AI 模型偏好 | `eva.ai.model` | 当前默认模型（含历史值自愈映射） | 长期保留 |
| 任务回退 | `qcb.tasks.v1` | 任务本地回退缓存 | 可清理 |
| 首页专注回退 | `qcb.attendance.v1` | 热力图/专注时长回退 | 可清理 |
| Blog 草稿 | `eva.blog.draft.v1` | 日志编辑草稿 | 可清理 |
| Notes 树缓存 | `eva:knowledge-tree` | 知识库树结构本地缓存 | 可清理，磁盘可重建 |
| Notes 文件回退 | `eva:file:*` | Web fallback 文件内容缓存 | 可清理 |
| 视频书签回退 | `eva.video.bookmarks.v1` | 资源站书签回退缓存 | 可清理 |
| Focus 运行态 | `eva.focus.activeRun.v1` | 运行中专注会话临时恢复（前端容灾） | 可清理 |
| Focus 筛选态 | `eva.focus.filters.v1` | 专注成就页筛选缓存（默认 all-time，可切 7d/30d/90d） | 可清理 |
| Focus 预设近期项 | `eva.focus.recentPresets.v1` | 任务页“专注预设”最近使用 Top3（仅交互加速） | 可清理 |

### 1.1 `eva.settings.v1` 字段快照（2026-02-25）

```ts
type AppSettings = {
	aiApiKey: string;
	aiKimiKey: string;
	aiMinimaxKey: string;
	lanShareEnabled: boolean;
	lanSharePort: number;
	fontScale: number;
	pomodoroBell: "beep" | "chime" | "digital";
	avatarUrl: string;
	backgroundUrl: string;
	defaultPomodoroMinutes: number;
	autoFullscreenPomodoro: boolean;
	animationLevel: "normal" | "reduced";
	docRoot: string;
	targetUniversity: string;
	examDate: string;
	targetScores: {
		politics: number;
		english: number;
		math: number;
		major: number;
	};
	// --- v1.4 规划新增 ---
	aiVisionModel: string;                    // 视觉模型，默认 "Pro/Qwen/Qwen2.5-VL-7B-Instruct"
	aiVisionMode: "single" | "pipeline";      // 图片识题模式：单步直接解题 or 流水线（先提取后解答）
};
```

### 1.2 设置读写约束

- 入口文件：`src/lib/settings.ts`。
- 统一键名：`eva.settings.v1`。
- 读取策略：`getSettings()` 以 `defaultSettings` 做兜底，保证新增字段向后兼容。
- 更新策略：
	- 局部修改可用 `updateSettings(patch)`。
	- 涉及嵌套对象（如 `targetScores`）时应传完整对象，避免浅合并导致字段丢失。
- 持久化事件：`saveSettings()` 会派发 `eva:settings-updated` 供页面联动。

---

## 2) Notes AI 对话存储设计（SQLite）

### 2.1 设计目标
- 页面刷新后保留完整历史对话，且不受浏览器缓存清理影响。
- 支持会话标题自动生成 + 手动重命名。
- 支持会话删除，且删除后自动切换可用会话。
- 由 Rust + SQLite 统一持久化，前端不保存对话正文。

### 2.2 数据结构

```ts
type ChatMessage = {
	id: string;
	session_id: string;
	role: "user" | "assistant";
	content: string;
	created_at: string;
};

type ChatSession = {
	id: string;
	title: string;
	created_at: string;
	updated_at: string;
};
```

### 2.3 读写策略
- **加载阶段**：前端启动时调用 `get_ai_sessions`，按 `updated_at DESC` 拉取会话列表。
- **消息加载**：切换会话时调用 `get_ai_messages(session_id)`。
- **写入阶段**：每条用户/助手消息都调用 `add_ai_message` 持久化。
- **一致性**：`add_ai_message` 内部更新 `ai_sessions.updated_at`，保证会话排序正确。

### 2.4 标题策略
- 新建会话默认标题 `新对话` 或首问摘要（前端传入）。
- 手动重命名调用 `update_ai_session_title`，写入 `ai_sessions.title`。

### 2.5 删除策略
- 删除会话调用 `delete_ai_session`。
- `ai_messages.session_id` 外键 `ON DELETE CASCADE`，自动级联删除全部历史消息。

---

## 3) 文件系统持久化（Rust）

| 模块 | 目录 | 形态 |
|---|---|---|
| 每日留痕 | `Documents/EVA_Knowledge_Base/Logs` | 多文件 Markdown |
| 知识库文件 | `Documents/EVA_Knowledge_Base/Notes` | 文件/目录真实拷贝、移动、删除 |
| 资源站文件 | `Documents/EVA_Knowledge_Base/Resources` | 文件/目录真实拷贝、删除 |
| 错题图片（v1.4 规划） | `Documents/EVA_Knowledge_Base/ErrorImages/{YYYY-MM}/` | AI 对话中上传的题目图片 |

---

## 4) SQLite 持久化（eva.db）

| 表 | 用途 |
|---|---|
| `tasks` | 任务管理 |
| `focus_sessions` | 专注时长兼容层（签到/旧热力图） |
| `focus_templates` | 可复用专注模板（番茄/倒计时） |
| `focus_runs` | 单次专注事件流水（统计主数据源） |
| `video_bookmarks` | 视频书签 |
| `resources` | 资源索引 |
| `questions` | 练功房题库 |
| `ai_sessions` | AI 会话元数据（标题、创建/更新时间） |
| `ai_messages` | AI 会话消息正文（用户/助手），v1.4 新增 `image_path` 列 |
| `wrong_questions` | 错题记录（v1.4 规划），含 SM-2 调度字段 |
| `weekly_review_items` | 真实自然周错题清单项（pending/done、下周延续） |

### 4.1 Focus 存储分层说明

- `focus_sessions`：保留历史兼容语义，承接签到/签退聚合与旧版热力图。
- `focus_runs`：记录每次开始与结束事件（`running/completed/aborted`），用于“专注成就”页的标签/模板/计时类型统计。
- `focus_templates`：沉淀可复用专注项，支持任务表单填充与 Dashboard 模板直启。
- `weekly_stats`（接口聚合结果，非新表）：周复盘页面仅消费周度统计，不再直接承载全量 Focus 占比探索。
- Focus 统计默认口径：`all-time`（全量历史），页面初始加载即使用 all-time，周窗口仅作为可选筛选视图。
- 存储主事实源：专注统计/模板数据以 SQLite（`focus_runs` / `focus_templates`）为准；localStorage 仅保存 UI 态缓存。

### 4.2 错题系统存储设计（v1.4 规划）

- `wrong_questions`：错题核心表，每条记录包含题目（Markdown + LaTeX）、AI 解答、原始图片路径、SM-2 调度参数（`ease_factor` / `interval_days` / `next_review_date` / `review_count` / `mastery_level`）。
- `ai_messages.image_path`：新增列，记录用户消息中附带的图片相对路径（`ErrorImages/YYYY-MM/uuid.ext`）。
- 图片存储策略：图片二进制写入 `Documents/EVA_Knowledge_Base/ErrorImages/` 目录，数据库仅存相对路径。桌面端读取绝对路径，Web 端通过 `/api/images/{path}` 静态服务访问。
- 错题溯源：`wrong_questions.ai_session_id` 外键指向 `ai_sessions.id`（ON DELETE SET NULL），`ai_message_ids_json` 记录关联消息 ID 数组。
- SM-2 口径：`next_review_date <= today AND is_archived = 0` 为待复习；`mastery_level = 0` 为未掌握。
- 留痕联动：收录错题时可选同步创建 `daily_logs` 条目，Tags 包含 `["错题", subject, ...]`。

---

## 5) IndexedDB 审计

- 当前项目未使用 IndexedDB。
- 缓存治理优先级：`localStorage` 键集合 + 文件系统目录 + SQLite 表数据。

---

## 6) 设置维护命令与存储映射（Rust）

| 命令 | 作用域 | 说明 |
|---|---|---|
| `get_storage_usage()` | SQLite / Notes / Resources / Logs | 统计各目录与数据库真实占用字节数 |
| `clear_cache("drafts")` | `eva.blog.draft.v1` | 清理留痕草稿缓存 |
| `clear_cache("tree")` | `eva:knowledge-tree` | 清理知识库树缓存 |
| `clear_cache("file")` | `eva:file:*` | 清理文件回退缓存 |
| `clear_cache("tasks")` | `qcb.tasks.v1`, `qcb.attendance.v1` | 清理任务与专注回退缓存 |
| `reset_all_data()` | 全部本地数据 | 清空数据库、知识库目录、资源站目录与相关缓存 |