# 考研辅助全栈平台 · PRD & Roadmap v2

> EVA 绫波丽主题 · 本地优先 · 2025-02 更新

---

## 0. 文档说明

本 PRD 是对 v1 版本的全面升级。基于项目当前真实代码审计（35 个 Tauri 命令、8 个页面路由、5 张 SQLite 表），明确区分 **已完成 / 已设桩但未完成 / 全新规划** 三类功能，形成可执行的开发路线图。

**最新进展（2026-02-25 补充）**：
- Notes AI 对话区已升级为 Markdown 流式渲染，支持 LaTeX 公式与代码高亮
- Quiz Phase 2 后端基座已启动：`questions` 表与 `create_question/get_questions` 命令已落地
- Phase 3 局域网共享基座已落地：`get_local_ip`、`toggle_local_server`、`/api/ping`
- Axum 已支持静态资源托管与 CORS，iPad 浏览器可直接访问 `http://<IP>:9527`
- Quiz 已完成 Tauri/HTTP 双模桥接：桌面端走 IPC，Web 端走 `/api/quiz/all|due`
- Tasks 已完成 Tauri/HTTP 双模桥接：`fetchTasks/addTask/modifyTask/removeTask`
- Axum 已新增 Tasks REST：`GET/POST /api/tasks`、`PUT/DELETE /api/tasks/{id}`
- Tasks 番茄钟在 Web 端已具备 Fullscreen API 优雅降级（不支持时自动回退页面内全屏）
- Phase 3 最终冲刺已完成：Dashboard 消除 Web 端原生调用白屏风险，Notes/Resources 跨端阅读闭环落地
- Phase 4 系统收尾已启动：Settings 的考研目标与隐私面板去 Mock，接入真实持久化与本地清理命令
- Phase 5 桌面原生化已完成：托盘常驻、全局快捷键呼出、关闭拦截后台运行、Axum 改为 `rust-embed` 内嵌静态资源并支持 SPA fallback

**最新策略（2026-02-27 补充）**：
- Focus 功能交互重心调整为“省时间、省心、直觉”：模板入口改为统一“专注预设”，避免“先建模板再填表”的反直觉链路。
- `WeeklyReview` 职责收敛为“周复盘单职责页面”，不再承载全量专注成就探索。
- 新增独立 `Focus Insights（专注成就）` 信息架构，承载标签/模板占比、TOP3、总累计等全量统计。
- 图表与数据卡严格遵循 EVA 主题色盘，不使用随机高饱和杂色。

**功能来源分类标记**：
- 🟢 **已完成** — 代码与 UI 均已就位，日常可用
- 🟡 **已设桩** — 项目中已有入口 / 占位代码 / 空壳 UI，需补全逻辑
- 🔵 **用户需求** — 用户明确提出的 4 项功能
- 🟣 **新增规划** — 审计后额外设计的 3 项功能

---

## 1. 产品定位与美学

### 1.1 一句话定位

> **一个本地优先、EVA 绫波丽美学的考研辅助个人操作系统，围绕「周一到周六专注执行、周日冷酷复盘」的周节奠，帮助考研人用最少操作完成计划制定、日常执行、知识沉淀与周期性复盘。**

### 1.2 核心用户画像

| 属性 | 描述 |
|------|------|
| 身份 | 考研备考学生（408 + 数一 + 英一 + 政治） |
| 痛点 | 需要在多科目之间高效切换、精确管理碎片化时间、快速沉淀与回顾知识；考研大部分时间依赖纸笔练习，软件必须极简、省时、不消耗认知资源 |
| 习惯 | 真正的重度刷题推导依赖纸笔，iPad/手机在局域网下的核心定位是副屏控制台（任务打卡、番茄钟）与随身资料库（知识库/资源站查阅） |
| 审美 | 偏好极简、高级感界面，减少视觉噪音提高专注力 |

### 1.3 设计语言

| 元素 | 规范 |
|------|------|
| 主色调 | 冷白 `#F8FAFC` / 深邃黑 `#0a1120` |
| 点缀色 | 绫波蓝 `#88B5D3`（信息态）· 初号机橙 `#FF9900`（警示/强调） |
| 面板 | 毛玻璃（`backdrop-blur-xl + bg-white/40`） |
| 圆角 | 卡片 `2rem`、按钮 `xl`、输入框 `xl` |
| 动画 | Framer Motion，支持三档：完整 / 减弱 / 关闭 |
| 字体 | 系统字体栈，支持全局缩放（0.8x–1.4x） |

---

## 2. 技术架构概览

```
┌─────────────────────────────────────────────────────┐
│               EVA 考研辅助终端 (Tauri v2)           │
│                                                     │
│  ┌───────────────┐          ┌───────────────────┐   │
│  │  桌面端 UI    │          │  局域网 Web UI    │   │
│  │  (WebView2)   │          │  (平板/手机访问)  │   │
│  └───────┬───────┘          └────────┬──────────┘   │
│          │                           │              │
│          ▼                           ▼              │
│  ┌─────────────────────────────────────────────┐    │
│  │            Rust 核心服务层                   │    │
│  │  33 Tauri Commands + Axum LAN Server        │    │
│  └──────┬──────────┬────────────┬──────────────┘    │
│         │          │            │                    │
│         ▼          ▼            ▼                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────────────┐    │
│  │ 文件系统 │ │  SQLite  │ │ AI 代理 (3家LLM) │    │
│  │ Logs/    │ │ eva.db   │ │ DeepSeek / Kimi  │    │
│  │ Notes/   │ │ 5 tables │ │ / MiniMax        │    │
│  │ Resources│ │          │ │                   │    │
│  └──────────┘ └──────────┘ └──────────────────┘    │
└─────────────────────────────────────────────────────┘
```

**当前存储分布**（详见 [数据存储白皮书](数据存储白皮书.md)）：

| 存储层 | 内容 |
|--------|------|
| **SQLite** (`eva.db`) | `tasks`、`focus_sessions`、`focus_templates`、`focus_runs`、`video_bookmarks`、`resources`、`questions` |
| **文件系统** | `Logs/*.md`（日志）、`Notes/`（知识库）、`Resources/`（资源） |
| **localStorage** | 设置、树缓存、草稿编辑器、AI Key 兼容读取 |

---

## 3. 功能模块现状审计

### 3.1 考研大盘 · Dashboard 🟢

**状态：已完成**

| 功能 | 说明 | 状态 |
|------|------|------|
| 考研倒计时 | 目标日 2026-12-20，精确到天 | 🟢 |
| 签到/签退打卡 | localStorage + SQLite 双写 | 🟢 |
| 番茄钟 | 普通 + 全屏沉浸模式，预设 25/50/5 分钟 + 自定义 | 🟢 |
| 30 天专注热力图 | GitHub 风格，基于 `focus_minutes` 渐变 | 🟢 |
| NERV 数据块 | 连续签到天数、日/周/7日均专注时长 | 🟢 |
| Focus 三入口番茄钟 | Dashboard 支持「按模板 / 按任务 / 快速启动」并写入 run 记录 | 🟢 |
| 专注成就入口 | 跳转独立 `Focus Insights` 页（全量历史统计） | 🟢 |
| 任务饼图 | todo/in-progress/done 三色 SVG | 🟢 |
| 今日待办清单 | 可直接勾选切换状态 | 🟢 |

**本期不扩展**，后续阶段追加「科目进度大盘」与「艾宾浩斯复习提醒」。

---

### 3.2 任务与计划 · Tasks 🟢

**状态：已完成（功能最丰富的模块）**

| 功能 | 说明 | 状态 |
|------|------|------|
| 待办列表 | 快速添加 + 完整表单 CRUD | 🟢 |
| 一键状态切换 | done ↔ todo | 🟢 |
| 优先级 / 标签 | P1–P4 色标渲染 | 🟢 |
| 日期导航 | 前后日切换 | 🟢 |
| 循环任务 | daily / weekly 自动在新日创建 | 🟢 |
| 一键延期 | +1 天快速顺延 | 🟢 |
| 日历视图 | 月历网格 + 每天任务圆点 | 🟢 |
| 时间线视图 | 垂直时间线 | 🟢 |
| 甘特图 | 日视图 + 周视图横向条形 | 🟢 |
| 每日小结 | 对话框展示 done/total 统计 | 🟢 |
| 单任务番茄钟 | 浮动 + 全屏 | 🟢 |
| 专注预设复用 | 任务表单使用统一“专注预设”入口（最近使用/我的模板/快捷预设） | 🟢 |
| 一键模板沉淀 | 支持“保存当前专注配置为模板”，不打断主提交流程 | 🟢 |
| Focus Run 持久化 | 任务计时开始/结束自动写入 `focus_runs`（完成/中止） | 🟢 |
| Markdown 导入 | 文件选择器 / 粘贴，解析 `- [ ]` 任务项 + `@date` + `#tag` | 🟢 |
| AI 闪电灵感 | 自然语言 → DeepSeek → 结构化任务批量创建 | 🟢 |
| **一键克隆昨日任务** | **今日无任务时，一键复制昨天任务列表，只需微调页码/章节即可** | 🟡 |
| **周常规模板** | **将当前任务列表保存为「周模板」，周日复盘后一键应用到下周每天** | 🟡 |
| **周视图** | **Mon–Sat 六列卡片布局，一览本周任务分配与完成情况** | 🟡 |
| **周计划 AI 分配** | **周复盘后 AI 建议下周任务 → 用户微调 → 一键生成到各天** | 🟡 |
| **未完成顺延** | **本周未完成任务一键顺延至下周** | 🟡 |

---

### 3.3 每日留痕 · Blog 🟢

**状态：已完成**

| 功能 | 说明 | 状态 |
|------|------|------|
| 日志 CRUD | 创建/编辑/删除，标题/标签/内容 | 🟢 |
| 搜索/过滤/排序/分页 | 10 条/页，按标签过滤 | 🟢 |
| Markdown 渲染 | ReactMarkdown + remark-gfm | 🟢 |
| 心情追踪 | happy/sad/neutral/focused + 同步率百分比 | 🟢 |
| 工具栏编辑器 | H1/H2/粗体/斜体/引用/代码/链接 快捷键 | 🟢 |
| AI 日报生成 | 基于当天任务自动生成日报（Kimi → DeepSeek 回退） | 🟢 |
| 草稿自动保存 | localStorage 暂存 | 🟢 |
| 视频时间戳 | `[MM:SS]` 可外部跳转 B 站带时间戳链接 | 🟢 |
| 详情页 | 独立路由 BlogPost 渲染/编辑/删除 | 🟢 |

**AI Prompt 底层约束（强制规范）**：底层系统指令必须深度定制。生成留痕需采用「EVA MAGI 战略分析」口吻并输出结构化指标（同步率、核心战果、异常波动）；AI 深度复盘需采用「冷酷战略导师」口吻，进行无情的数据弱点剖析与伪勤奋剥离，拒绝无意义的寒暄与废话。

**周复盘文章支持**：Blog 同时承载「周复盘」类型文章（标签为 `周复盘`），由 Dashboard 周复盘工作流自动生成并保存。周复盘文章包含结构化数据摘要 + AI 分析 + 下周计划，可检索、可对比、可回溯。

**边界说明（2026-02-27）**：周复盘页只做“周复盘结论”，全量专注占比与成就看板迁移至独立 `Focus Insights` 页。

---

### 3.4 知识库 · Notes 🟢

**状态：核心可用，进入体验优化阶段**

| 功能 | 说明 | 状态 |
|------|------|------|
| 树形文件浏览器 | 文件夹/文件图标，可折叠 | 🟢 |
| 文件上传 (dialog) | Tauri dialog → 复制到 Notes/ | 🟢 |
| 文件夹创建 | 磁盘创建 + 树同步 | 🟢 |
| 重命名 / 删除 / 移动 | 单个 + 批量，磁盘操作 + 树同步 | 🟢 |
| 拖拽 | 内部重排 + 外部文件拖入 | 🟢 |
| 多选 | Ctrl+点击 / Shift+范围选 | 🟢 |
| 右键菜单 | 打开/重命名/删除/移动 | 🟢 |
| 预览 | Markdown / 纯文本 / PDF (iframe) | 🟢 |
| AI 多会话聊天 | DeepSeek/Kimi/MiniMax 模型切换，历史记录 | 🟢 |
| AI 对话持久化 | 会话列表/消息/活跃会话本地保存，刷新后可恢复 | 🟢 |
| AI 会话管理 | 支持会话重命名与删除 | 🟢 |
| AI 输出增强 | Markdown + LaTeX + 代码高亮 | 🟢 |
| 上下文注入 | 勾选文件 → 读取内容 → 作为 AI 上下文 | 🟢 |
| 搜索框 | 关键词递归过滤，命中项父目录自动展开 | 🟢 |
| 树持久化 | 启动可从磁盘扫描并重建树结构 | 🟢 |

---

### 3.5 资源站 · Resources 🟢（部分 🟡）

**状态：视频书签完整，文件资源持久化缺失**

| 功能 | 说明 | 状态 |
|------|------|------|
| 视频书签 | 输入 BV 号 → Rust 抓取元数据 → SQLite 存储 → 卡片展示 | 🟢 |
| 书签 CRUD | 创建/删除 | 🟢 |
| 外部打开视频 | opener 插件打开浏览器 | 🟢 |
| 学科筛选标签 | 按 subject 过滤 | 🟢 |
| 文件上传 | dialog 选文件 → `copy_files_to_resources` | 🟢 |
| **资源列表持久化** | **已接入 SQLite `resources` 表，页面刷新后可恢复** | 🟢 |
| **搜索框** | **已绑定 onChange，支持按资源名/科目过滤** | 🟢 |
| **下载按钮** | **已接入 `openPath`，可在系统默认应用打开文件** | 🟢 |
| **文件夹上传** | **已支持目录递归拷贝 + 批量入库** | 🟢 |
| **生成试卷** | **仅 `navigate('/quiz?generated=true')`，无实际生成** | 🟡 |

---

### 3.6 练功房 · Quiz ❄️（前端冻结）

**状态：前端入口已隐藏，后端题库能力保留（兼容历史数据）**

| 功能 | 现状 | 目标 |
|------|------|------|
| 学科标签 | UI 渲染但不切换内容 | 按科支持筛选与切换 |
| 题目展示 | 1 道硬编码 AVL 树选择题 | 接入题库 / AI 动态生成 |
| 答题交互 | 选择后可下一题但仅重置 | 完整答题流程 + 正确率统计 |
| 题库 | 完全缺失 | SQLite 存储 + 错题本归档 |
| 间隔重复 | 完全缺失 | 艾宾浩斯提醒算法 |

**当前策略**：Quiz 仅保留数据与接口，不在 Dashboard/Sidebar/Resources 暴露入口；后续是否重启以阶段规划为准。

**详细设计见 §4.5（远期）**

**最新进展（2026-02-25 补充）**：
- 已完成基础闭环：手动录题（Modal）→ 真实刷题（SQLite）→ 判题落盘（统计更新）
- 题干与解析已支持 Markdown + LaTeX 渲染
- 新增 `answer_question` 命令，记录 `review_count/correct_count/next_review`
- 资源站已打通真实 AI 出题链路：选中文件 → 读取文本 → DeepSeek 生成 JSON 题目 → 自动入库
- `answer_question` 已升级为基础 SM-2 间隔重复算法（`interval` / `ease_factor` / `next_review`）
- Quiz 已新增「今日待复习」视图，可筛选 `next_review <= now` 且 `review_count > 0` 的题

---

### 3.7 系统设置 · Settings 🟢

**状态：10/10 标签页已进入真实可用阶段（含 sync / exam / privacy）**

| 标签页 | 说明 | 状态 |
|--------|------|------|
| 通用 (general) | 开机自启动 (autostart 插件) | 🟢 |
| 外观 (appearance) | 字体缩放、头像 URL、侧边栏背景、动画等级 | 🟢 |
| AI (ai) | DeepSeek / Kimi / MiniMax 三家 API Key | 🟢 |
| 工作区 (workspace) | 文档根目录选择器、在资源管理器中打开 | 🟢 |
| 番茄钟 (pomodoro) | 默认分钟数、铃声、自动全屏 | 🟢 |
| 快捷键 (shortcut) | 静态快捷键列表展示 | 🟢 |
| 关于 (about) | 版本信息 | 🟢 |
| **同步与备份 (sync)** | **已接真实局域网 IP 与服务开关，支持本地服务启停** | 🟢 |
| **考研目标 (exam)** | **已接真实持久化字段（目标院校/考试日期/各科目标分）并支持回显** | 🟢 |
| **隐私与安全 (privacy)** | **已接真实存储统计、分类清理与一键重置（含确认拦截）** | 🟢 |

---

### 3.8 后端 Tauri 命令层 🟢

**状态：核心命令已实现，错误处理完备（含 Resources 持久化与递归上传命令）**

| 分组 | 命令数 | 说明 |
|------|--------|------|
| 任务 CRUD | 6 | get/create/update/delete/batch_create + 按日期查询 |
| 日志 CRUD | 4 | .md 文件读写（YAML frontmatter） |
| 专注会话 | 2 | get + upsert |
| 视频书签 | 3 | get/add/delete |
| AI / 外部 API | 2 | `ai_proxy` + `fetch_bilibili_metadata` |
| 工作区 | 3 | initialize + initialize_at + get_root |
| 文件读取 | 3 | read_file_content + get_*_dir |
| 知识库操作 | 8 | copy/batch_copy/delete/batch_delete/move/batch_move/write/create_folder |
| 资源操作 | 5 | get/add/delete + batch_copy_files + batch_copy_folder |
| MD 导入 | 1 | parse_markdown_plan |
| 系统维护 | 3 | get_storage_usage + clear_cache + reset_all_data |

**局域网服务现状**：已从空壳升级为可运行 Axum 服务，包含 `/api/ping`、`/api/quiz/all`、`/api/quiz/due` 与静态页面托管。

**Phase 3 最终冲刺（已完成）**：
- 首页（Dashboard/Home）已完成双模桥接，Web 端不再直接依赖原生 `invoke`。
- Axum 已增补阅读接口：`/api/notes/tree`、`/api/notes/file`、`/api/resources`。
- `apiBridge.ts` 已扩展 Dashboard/Notes/Resources 统一桥接方法。
- Notes/Resources 在 Web 端默认“只读模式”，文件管理能力禁用并提供明确提示。

---

## 4. 新功能详细设计

> 本节覆盖 12 项功能：4 项用户需求 (🔵)、5 项已设桩补全 (🟡→🟢)、3 项新增规划 (🟣)

---

### 4.1 🔵 局域网共享 (LAN Sharing)

**目标**：将 iPad/手机定位为学习副屏与资料阅读端，而非主力刷题端；在同一 WiFi 下提供任务与时间中枢、跨端阅读与轻量回顾能力。

**用户故事**：
> 考研人在纸笔/电脑上完成重度刷题推导 → 抬头用 iPad 查看今日任务与番茄钟状态并打卡 → 课间用手机查阅知识库和资源站资料 → 晚上用平板轻量查看「今日待复习」。

**核心场景（Top 3）**：
1. **任务与时间中枢**：在平板上查看今日任务、勾选完成状态、同步操控番茄钟，作为学习副屏。
2. **跨端阅读**：在平板上流畅阅读电脑“资源站”和“知识库”中的 Markdown/PDF 资料。
3. **轻量回顾**：辅以错题本（Quiz）的轻量级“今日待复习”查看（以回顾为主，不承载重度推导）。

**技术方案**：

| 层级 | 方案 |
|------|------|
| HTTP 框架 | Axum（统一承载 REST + WebSocket） |
| 静态托管 | Vite 打包产物内嵌至 Rust 二进制（`rust-embed` + SPA fallback） |
| 数据 API | RESTful API 负责拉取/写入，首屏和兜底走 HTTP |
| 实时同步 | **必须引入 WebSocket 广播通道（可选 SSE 退化）**，用于跨端无刷新状态推送 |
| 端口 | 默认 `0.0.0.0:9527`，可在设置中修改 |
| IP 发现 | 启动后自动检测局域网 IP，在设置 > 同步与备份中展示 |
| 安全 | 可选 PIN 码访问保护（4 位数字，类似 AirDrop） |

**架构收敛结论（2026-02-26）**：
- 仅靠 REST 轮询无法满足“平板打卡后桌面端立刻更新、桌面建任务后平板立刻出现”的体验目标。
- 系统必须采用“REST + WebSocket 广播”双轨模型：
  1. 写操作仍由 REST / Tauri Command 落库；
  2. 落库成功后向广播总线发送 `SYNC_TASKS` 等事件；
  3. Web 端通过 `ws://<host>/api/ws` 收到事件后静默刷新；
  4. 桌面端通过 Tauri `emit("sync-update")` 同步触发同样刷新。
- 该模式是“多端无刷新双向同步”的强制基础能力，不再作为可选优化项。

**交互设计**：

1. **设置 > 同步与备份** 标签页中：
   - 开关 "启用局域网共享"
   - 显示 `http://192.168.x.x:9527` 地址 + 二维码（QR）
   - 可修改端口号
   - 可设置 4 位 PIN 码
   - 已连接设备列表（IP + 设备 User-Agent）
2. **状态指示器**：侧边栏底部显示 📡 图标 + 连接数
3. **权限分级**：
   - **只读模式**（默认）：查看任务/笔记/日志，不可修改
   - **读写模式**：需输入 PIN 码，可创建/编辑任务和日志

**API 路由规划**（部分）：

```
GET    /api/tasks?date=2026-02-25
POST   /api/tasks
PUT    /api/tasks/{id}
DELETE /api/tasks/{id}
GET    /api/ws
GET    /api/logs
GET    /api/notes/tree
GET    /api/notes/file?path=xxx
GET    /api/focus
POST   /api/focus
```

**同步事件规范（首版）**：

```json
{ "action": "SYNC_TASKS" }
```

- 触发点：任务增删改、批量导入任务。
- 接收端：`Tasks`、`Dashboard`。
- 刷新原则：静默刷新数据，禁止触发全屏 Loading。

---

### 4.2 🔵 内网穿透 (Tailscale) — ❘ 已降优至 Phase 7 远期

> **降优理由（2026-02-26）**：考研场景 99% 处于同一 WiFi（宾馆/宅/图书馆/教室），局域网共享已完全满足副屏需求。Tailscale 涉及第三方客户端安装、ACL 策略配置等额外心智消耗，与「极简省时」核心理念冲突。先搞定周复盘闭环。

**目标**：让手机/平板在外网环境也可访问桌面端数据，不依赖公网服务器。

**前置条件**：用户已在桌面端和移动端安装 Tailscale 客户端并加入同一 Tailnet。

**交互设计**：

1. **设置 > 同步与备份** 标签页中（在局域网共享下方）：
   - 展示 Tailscale 连接状态（在线 / 离线 / 未安装）
   - 展示 MagicDNS 地址（如 `eva-desktop.tailnet-xxxx.ts.net:9527`）
   - 展示 100.x.x.x Tailscale IP
   - "一键检测连通性" 按钮（向 Tailscale API 查询设备列表）
   - 外网访问说明卡片（步骤指引 + FAQ）

**技术方案**：

| 组件 | 说明 |
|------|------|
| 检测 | 调用 `tailscale status --json` 解析设备列表和网络状态 |
| 地址 | MagicDNS 或 100.x IP + 局域网共享端口 |
| 安全 | Tailscale 本身基于 WireGuard 加密；ACL 策略建议只授权特定设备 |
| 复用 | 复用局域网共享的 Axum Server，不需额外服务 |

**限制**：本平台不内嵌 Tailscale 运行时，仅做状态检测和地址展示。

---

### 4.3 🔵 缓存清理 (Cache Cleanup)

**目标**：一键清理各类缓存和临时数据，释放空间并解决数据异常，让考研人不必操心技术细节。

**当前缓存分布**（基于 [数据存储白皮书](数据存储白皮书.md) 审计）：

| 缓存类型 | 键 / 位置 | 大小估计 |
|----------|-----------|----------|
| 设置 | `eva.settings.v1` | < 1 KB |
| 任务回退 | `qcb.tasks.v1` | 1–50 KB |
| 专注回退 | `qcb.attendance.v1` | 1–10 KB |
| 博客草稿 | `eva.blog.draft.v1` | 0–5 KB |
| AI Key 兼容 | `eva.ai.api.key` | < 0.1 KB |
| 知识库树 | `evaknowledge-tree` | 1–100 KB |
| 文件内容回退 | `eva.file:*` | 0–500 KB |
| 视频书签 | `eva.video.bookmarks.v1` | 1–10 KB |

**交互设计**：

1. **设置 > 隐私与安全** 标签页中（替代原占位文字）：
   - **存储用量面板**：饼图展示 SQLite / 文件系统 / localStorage 各占多少空间
   - **分类清理卡片**，每张卡片有名称、大小、上次更新时间、清理按钮：
     - 🗑️ 编辑器草稿 — 清理 `eva.blog.draft.v1`
     - 🗑️ 知识库树缓存 — 清理 `evaknowledge-tree`，下次打开知识库页从磁盘重建
     - 🗑️ 文件内容缓存 — 清理所有 `eva.file:*` 键
     - 🗑️ 任务本地回退 — 清理 `qcb.tasks.v1`（提示：如果 SQLite 正常则无需保留）
     - 🗑️ 专注数据回退 — 清理 `qcb.attendance.v1`
     - 🗑️ 视频书签本地回退 — 清理 `eva.video.bookmarks.v1`
   - **一键全部清理** 按钮（弹出确认对话框，列出即将清除的内容）
   - **危险操作区**（红色边框）：
     - 🔴 重置所有设置 — 清理 `eva.settings.v1`，恢复默认值
     - 🔴 清空数据库 — 清除 SQLite 全部表数据（需二次确认 + 输入"确认"文字）

2. **清理后反馈**：显示释放了多少空间，受影响的缓存项数量。

**Tauri 命令扩展**：

```rust
#[tauri::command]
fn get_storage_stats() -> StorageStats { ... }   // 返回各存储层占用

#[tauri::command]
fn clear_sqlite_table(table: String) -> Result<(), String> { ... }

#[tauri::command]
fn get_workspace_size() -> u64 { ... }           // 递归计算文件系统大小
```

---

### 4.4 🔵（部分🟢）AI 生成功能增强

**目标**：以 SiliconFlow OpenAI 兼容接口为主，优先打通 DeepSeek-V3.2 流式能力，让 AI 成为考研复习的"副驾驶"。

**当前状态（2026-02-25）**：
- ✅ Settings 已支持 API Key 持久化与模型选择（默认 `deepseek-ai/DeepSeek-V3.2`）
- ✅ 新增前端统一客户端 `src/utils/aiClient.ts`，支持 SiliconFlow 流式返回
- ✅ 知识库 AI 对话已接入流式打字机渲染（最小连通测试：输入"你好"可返回）
- ✅ 已兼容旧模型缓存值（如 `deepseek-v3`）并自动映射为 `deepseek-ai/DeepSeek-V3.2`
- ✅ Notes AI 对话支持本地持久化恢复，会话可重命名、可删除
- 🟡 意图模式、题目生成、周复盘等高级能力仍待补齐

**当前已有 AI 能力**（保留不变）：

| 能力 | 位置 | 说明 |
|------|------|------|
| AI 代理 | `lib.rs:ai_proxy` | 透传三家 LLM，支持模型选择 |
| 自然语言 → 任务 | Tasks 页 "闪电灵感" | 文字描述 → 结构化任务批量创建 |
| AI 日报 | Blog 页 "AI 帮我写" | 基于今日任务自动生成日报 |
| 知识库问答 | Notes 页 AI 面板 | 勾选文件 → 注入上下文 → 对话 |

**新增 AI 能力**：

#### 4.4.1 意图模式切换

在 AI 对话输入框上方增加模式切换条：

| 模式 | 系统 Prompt 行为 | 适用场景 |
|------|------------------|----------|
| 📖 总结 | 压缩输入为要点清单 | 读完一章笔记后快速提取重点 |
| 🔍 检索 | 在注入的文件中定位关键段落并引用出处 | 找某个公式 / 定理在哪篇笔记里 |
| ✏️ 生成 | 根据指令创造新内容（题目/大纲/模板） | 生成练习题、周计划模板 |
| 📅 计划 | 输出结构化日/周计划（含日期、科目、时长分配） | "帮我安排下周复习进度" |
| 🔄 复盘 | 分析完成率、找出薄弱环节、给出改进建议 | 每周日回顾本周数据 |

**交互**：默认"总结"模式；切换模式时，系统 Prompt 前缀自动变化，历史记录保留。

#### 4.4.2 AI 生成练习题

用户在知识库勾选若干笔记文件 → 右键或工具栏点击 "生成练习题" → AI 读取文件内容 → 输出结构化的选择题 / 填空题 / 简答题 → 用户确认后写入 Quiz 练功房题库。

**数据结构**：

```typescript
interface Question {
  id: string;
  subject: "408-ds" | "408-cn" | "408-os" | "408-co" | "math" | "english" | "politics";
  type: "choice" | "fill" | "short-answer";
  stem: string;                   // 题干
  options?: string[];             // 选择题选项
  answer: string;                 // 答案
  explanation: string;            // 解析
  source_files: string[];         // 来源笔记路径
  difficulty: 1 | 2 | 3;         // 难度
  created_at: string;
  next_review?: string;           // 下次复习日期（间隔重复）
  review_count: number;           // 复习次数
  correct_count: number;          // 答对次数
}
```

#### 4.4.3 AI 周复盘报告

每周日（或用户手动触发），AI 自动：
1. 读取本周所有 `focus_sessions` 数据
2. 读取本周任务完成率（按科目统计）
3. 读取本周日志的心情趋势
4. 生成一份结构化周报：
   - 科目时间分配饼图（数据由前端基于返回数据渲染）
   - 完成率趋势
   - 薄弱科目预警
   - 下周建议安排

#### 4.4.4 上下文可见性

在 AI 对话回复中，被引用的笔记片段以"引用气泡"展示，点击可跳转到 Notes 页对应文件。让用户清楚 AI 依据了什么资料回答问题。

#### 4.4.5 失败兜底

当知识库中找不到相关资料时，AI 不生硬回答，而是给出：
- "知识库中未找到相关内容"
- "建议补充以下资料：[关键词列表]"
- "是否改为联网搜索？（调用通用模型）"

---

### 4.5 🟡 练功房升级 (Quiz Enhancement) — ❘ 已降优至 Phase 7 远期

> **降优理由（2026-02-26）**：考研重度刷题推导完全依赖纸笔 + 练习册，软件刷题坚决不会是高频操作。当前基础闭环（手动录题 + SM-2 复习 + AI 出题）已足够支撑轻量复习场景。深度练功房（模拟考试/错题本归档/随机组卷）不再占用开发带宽，优先保证周复盘闭环落地。

**现状**：基础闭环已可用（手动录题 + SM-2 + 今日待复习），深度功能暂停。

**目标**：打造一个完整的刷题 + 错题本 + 间隔重复系统。

**功能矩阵**：

| 功能 | 说明 |
|------|------|
| 题库 CRUD | SQLite `questions` 表，支持手动录入 + AI 生成入库 |
| 学科切换 | 顶部标签按科目过滤（408 细分到数据结构/计网/OS/组成原理） |
| 答题模式 | 顺序练习 / 随机抽取 / 错题重做 / 模拟考试（限时 + 随机组卷） |
| 答题反馈 | 选择后即时显示对错 + 解析 + 来源笔记链接 |
| 正确率统计 | 科目维度的正确率面板（总体 / 近 7 天 / 近 30 天） |
| 错题本 | 答错自动归档，可手动标记"已掌握"移出 |
| 间隔重复 | 基于 SM-2 算法（SuperMemo）计算下次复习日期，首页 Dashboard 展示今日待复习题数 |
| AI 出题 | 勾选笔记 → AI 输出 JSON 题目 → 预览 → 确认入库 |

**SQLite 新增表**：

```sql
CREATE TABLE IF NOT EXISTS questions (
    id          TEXT PRIMARY KEY,
    subject     TEXT NOT NULL,
    type        TEXT NOT NULL DEFAULT 'choice',
    stem        TEXT NOT NULL,
    options     TEXT,              -- JSON array
    answer      TEXT NOT NULL,
    explanation TEXT DEFAULT '',
    source_files TEXT DEFAULT '[]', -- JSON array
    difficulty  INTEGER DEFAULT 2,
    created_at  DATETIME DEFAULT CURRENT_TIMESTAMP,
    next_review DATETIME,
    review_count INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    ease_factor REAL DEFAULT 2.5   -- SM-2 算法参数
);
CREATE INDEX idx_questions_subject ON questions(subject);
CREATE INDEX idx_questions_next_review ON questions(next_review);
```

**Tauri 命令扩展**（6 个）：

```
get_questions(subject?, type?, limit?)
create_question(question)
batch_create_questions(questions)
update_question_review(id, is_correct)   // 更新 SM-2 参数
delete_question(id)
get_due_questions(date)                  // 获取今日待复习题
```

**当前实现补充（2026-02-25）**：
- 已实现：`get_questions`、`get_due_questions`、`create_question`、`answer_question`（含基础 SM-2）
- 待实现：`batch_create_questions`、`delete_question`

---

### 4.6 🟢（部分）资源站持久化与搜索补全

**当前状态（2026-02-25）**：资源持久化、搜索、下载打开、文件夹递归上传均已实现；“生成试卷”能力仍待联动 Quiz 题库。

**修复方案**：

| 修复项 | 方案 |
|--------|------|
| 资源持久化 | 新增 SQLite `resources` 表，记录文件名、路径、科目、大小、上传时间 |
| 搜索框 | 绑定 `onChange`，对资源名 + 科目标签做模糊匹配过滤 |
| 下载按钮 | 调用 `opener::openPath` 在系统文件管理器中定位文件 |
| 文件夹上传 | 使用 `dialog.open({ directory: true })` 选中目录 → Rust 递归遍历 → 批量复制 + 入库 |
| 生成试卷 | 连接 Quiz 练功房，基于勾选的资源内容调用 AI 生成题目 |

**SQLite 新增表**：

```sql
CREATE TABLE IF NOT EXISTS resources (
    id          TEXT PRIMARY KEY,
    name        TEXT NOT NULL,
    path        TEXT NOT NULL,      -- 相对于 Resources/ 的路径
    file_type   TEXT DEFAULT 'file', -- file / folder
    subject     TEXT DEFAULT '',
    size_bytes  INTEGER DEFAULT 0,
    created_at  DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

### 4.7 🟡 知识库搜索与树同步

**现状**：搜索框有 UI 无逻辑；树仅存 localStorage，磁盘外部修改不同步。

**修复方案**：

| 修复项 | 方案 |
|--------|------|
| 搜索 | `onChange` 绑定关键词 → 递归遍历树节点做文件名模糊匹配 → 高亮命中项 + 自动展开父节点 |
| 全文搜索 | 可选：调用 Tauri 命令在 `Notes/` 下 `grep` 文件内容 → 返回匹配片段 + 文件路径 |
| 树同步 | 增加"刷新"按钮：调用 Rust 命令扫描 `Notes/` 磁盘目录 → diff 与 localStorage 树 → 合并 |
| 自动同步 | 页面 mount 时自动检测：对比树节点数 vs 磁盘文件数，若差异 > 5% 则弹提示 |

**Tauri 命令扩展**：

```
scan_notes_directory() -> TreeNode[]           // 递归扫描磁盘目录树
search_notes_content(keyword) -> SearchHit[]   // 全文搜索
```

---

### 4.8 🟡 设置占位标签补全

三个 `renderPlaceholder(...)` 标签页需要用实际功能替代：

| 标签页 | 归属功能 | 内容 |
|--------|----------|------|
| 同步与备份 (sync) | §4.1 局域网共享 + §4.2 内网穿透 | LAN Server 开关、IP/端口/PIN/二维码、Tailscale 状态、连接数 |
| 考研目标 (exam) | §4.12 考研科目目标体系 | 总分目标、各科目标、阶段里程碑、当前进度条 |
| 隐私与安全 (privacy) | §4.3 缓存清理 | 存储用量面板、分类清理、危险操作区 |

---

### 4.9 🟢 `daily_logs` 空表清理

**现状**：`lib.rs` 行 175 创建了 `daily_logs` SQLite 表，但所有日志 CRUD 操作都走 `Logs/*.md` 文件系统。这张表从未被插入或查询。

**结果（2026-02-25）**：已删除建表语句与相关索引。日志继续沿用 YAML frontmatter + Markdown 文件方案。

---

### 4.10 🟣 每日复盘仪表盘 (Daily Review Dashboard)

**设计理念**：考研人最害怕的不是不努力，而是不知道今天够不够努力。用一页仪表盘给出清晰答案。

**入口**：Dashboard 页新增"今日复盘"按钮，或每天 22:00 后自动弹窗提醒。

**面板内容**：

| 区域 | 展示内容 |
|------|----------|
| 🎯 完成率环形图 | 今日任务 done/total，按科目分色 |
| ⏱ 时间数据 | 总专注时长、签到时间、签退时间、番茄钟个数 |
| 📊 科目时间分配 | 水平条形图：每科目花了多少小时 |
| 📝 今日留痕摘要 | 如果有日志，展示第一段；如果没有，引导去写 |
| 🧠 同步率 | 综合评分 = 0.4×完成率 + 0.3×专注时长达标率 + 0.3×日志完成 |
| 💡 AI 一句话点评 | 调用 AI 生成 ≤ 50 字鼓励/建议 |

**AI Prompt 底层约束（复盘专用）**：系统指令必须深度定制——采用「冷酷战略导师」口吻，对数据弱点进行无情剖析与伪勤奋剥离，拒绝无意义的寒暄与废话。复盘输出必须包含结构化指标（完成率、专注饱和度、科目偏科预警），且给出可执行的改进动作而非空泛鼓励。

**操作**：
- "写今日留痕" → 跳转 Blog 编辑器，自动填充日期
- "查看本周趋势" → 跳转周复盘页

---

### 4.11 🟣 智能碎片时间助手 (Smart Break Planner)

**设计理念**：考研人的碎片时间（等公交、排队、课间）常被浪费。用户告诉系统"我有 15 分钟"，系统推荐最值得做的事。

**入口**：Dashboard 或侧边栏快捷入口，一个显眼的 "碎片时间" 按钮。

**交互流程**：

```
用户点击 "碎片时间" → 
  弹出模态框："你现在有多少时间？" 
  选项：5分钟 / 10分钟 / 15分钟 / 30分钟 / 自定义
→ 系统综合以下数据源做推荐：
  1. 今日未完成任务中最高优先级的
  2. 今日到期的间隔重复题目（练功房）
  3. 最近 3 天未复习的笔记
→ 输出推荐卡片（1-3 条），每条带"开始"按钮：
  - "复习 3 道操作系统错题" → 跳转 Quiz，自动筛选
  - "完成任务：整理线代笔记 Chapter 3" → 跳转 Tasks
  - "快速浏览笔记：计网 TCP 三次握手" → 跳转 Notes 并打开文件
```

**推荐算法**（优先级从高到低）：
1. 今日待复习的间隔重复题（距离遗忘曲线最近的）
2. 今日未完成的 P1/P2 任务中预估时长 ≤ 用户可用时间的
3. 近 7 天新增但未复习的笔记
4. 如果都没有 → 推荐 "做 X 分钟番茄钟读 [最近编辑的笔记]"

---

### 4.12 🟣 考研科目目标与进度体系 (Exam Goal Tracker)

**设计理念**：考研是长线战斗，需要把大目标拆到周、月可感知的进度条。

**入口**：设置 > 考研目标标签页（替代占位文字）+ Dashboard 科目进度区。

**设置页功能**：

| 字段 | 说明 | 示例 |
|------|------|------|
| 目标院校 | 文本输入 | "浙江大学 计算机学院" |
| 目标总分 | 数字输入 | 380 |
| 各科目标分 | 4 个数字输入 | 408: 120 / 数一: 130 / 英一: 75 / 政治: 70 |
| 考试日期 | 日期选择器 | 2026-12-20（与 Dashboard 倒计时联动）。**技术要求**：必须通过时间计算 Hook (`useMemo` + 定时刷新 state) 建立全局响应式联动，确保设置修改后或跨天时，Dashboard 倒计时能毫秒级静默同步，拒绝静态字符串渲染 |
| 阶段里程碑 | 可添加多条，每条含名称+截止日期+描述 | "数学第一轮复习完成 · 2026-04-30" |
| 408 子科目权重 | 4 个百分比滑块 | 数据结构 30% / 计网 25% / OS 25% / 组成原理 20% |

**Dashboard 科目进度区**（新增卡片）：

```
┌──────────────────────────────────────────────┐
│  📊 科目进度                                 │
│                                              │
│  408 ████████░░░░░░░░ 52%  目标 120          │
│    ├ 数据结构  ██████████░░ 80%              │
│    ├ 计算机网络 ████████░░░░ 65%              │
│    ├ 操作系统  ████░░░░░░░░ 35%              │
│    └ 组成原理  ██░░░░░░░░░░ 20%              │
│  数一 ██████░░░░░░░░░░ 40%  目标 130          │
│  英一 ████████████░░░░ 78%  目标 75           │
│  政治 ██░░░░░░░░░░░░░░ 15%  目标 70           │
│                                              │
│  下一里程碑：数学第一轮复习 · 剩余 64 天       │
└──────────────────────────────────────────────┘
```

**进度计算方式**：`科目进度 = 该科目已完成任务数 / 该科目总任务数 × 100%`

依赖：任务标签包含科目名即可自动识别归属，不需要改数据模型。

---

### 4.13 移动端与 Web 局域网适配规范

**目标**：在不牺牲桌面端效率的前提下，为 iPad/手机提供稳定、克制、可触达的副屏体验。

**1) 布局策略（强约束）**：
- **Landscape（横屏）**：沿用桌面信息架构，保持“导航 + 内容”左右分栏思路。
- **Portrait（竖屏）**：切换为上下堆叠主布局，导航改为底部抽屉/底部 Tab，不再保留左侧常驻栏。
- 响应式断点原则：移动端默认单列，`md` 以上再恢复多列/分栏，不允许在窄屏强行并排复杂卡片。

**2) 视觉焦点锚定（必须执行）**：
- 背景图主视觉焦点位于画面偏右 `2/5`，竖屏裁剪时必须锚定右侧主体。
- CSS 规范：使用 `background-position: 80% center`（或等效 `object-position: 80% center`）。
- 禁止在移动端使用默认 `center center` 导致主角被裁切出可视区域。

**3) 功能范围克制（Web 端白名单）**：
- Web（平板/手机）仅保留以下核心功能：
  - Dashboard（首页仪表盘）
  - Tasks + 全屏番茄钟
  - Notes（仅限沉浸式知识库阅读，移动端彻底隐藏/屏蔽 AI 对话侧边栏，将 100% 屏幕宽度交还给文档）
  - Resources（资源查阅）
  - Quiz due（轻量回顾）
- **强制隐藏/拦截**：
  - Settings 页面
  - 系统级数据清理与重置操作
- 文案统一：`设置仅在桌面端开放`。

---

### 4.14 🟣 周复盘工作流与周计划体系 (Weekly Review & Planning)

**设计理念**：考研是长线战斗，不是短跑。每天复盘太频繁、太耗心智；但完全不复盘又会迷失方向。建立「周一到周六专注执行、周日冷酷复盘」的节奠——每天操作不超过 2 分钟，周日 15 分钟完成一周闭环。

**三维度设计原则**：

| 维度 | 核心痛点 | 解法 |
|------|----------|------|
| ① 极速排表 | 每天手打“背单词/做数学”极其反人类 | 一键克隆昨日 + 周常规模板，10 秒完成排计划 |
| ② 无感留痕 | 为了复盘而复盘，执行时压力大 | 系统后台静默聚合 6 天数据，用户只管勾 Checkbox |
| ③ MAGI 周报 | 周日面对空白屏幕，不知道复盘什么 | 图表自动生成 + AI 战略推演，用户只看结论 |

**核心节奠模型**：

```
┌─────────────────── 一周闭环 ──────────────────┐
│                                                  │
│  周日晚 ─→ 周计划 (5min)                         │
│     │     AI 建议 + 拖拽微调 → 任务自动分配到周一~周六 │
│     ▼                                            │
│  周一~周六 ─→ 日执行 (2min/天)                   │
│     │     打卡 → 番茄钟 → 勾选任务 → 一键留痕       │
│     ▼                                            │
│  周日 ─→ 周复盘 (15min)                          │
│     │  一键聚合 → AI 冷酷分析 → 下周计划           │
│     └────── 闭环回到周计划 ─────────────────┘
```

**入口与存储决策**：
- **入口**：新增 `/weekly-review` 独立路由（侧边栏增加「周复盘」入口），Dashboard 顶部横幅一键直达
- **存储**：复盘结果保存为 Blog 文章（标签 `周复盘`），零新数据模型成本
- **周日自动提示**：周日时 Dashboard 顶部自动出现釉缸风格横幅，非周日可手动触发

#### 4.14.1 极速排表系统（维度①）

**目标**：将每日排计划的时间压缩到 10 秒以内。

**a) 一键克隆昨日任务**：
- 触发条件：当前日期无任何任务时，Tasks 页顶部出现「📋 克隆昨日任务」按钮
- 行为：复制昨天所有任务到今天，状态重置为 `todo`，保留标签/优先级/科目
- 用户只需微调具体页码/章节号，不需要重新输入任务名
- 如果昨日也无任务，向前回溯最近有任务的一天

**b) 周常规模板**：
- 入口：Tasks 页工具栏「💾 保存为周模板」按钮
- 保存当前任务列表为骨架模板（仅保留任务名、科目标签、优先级，不保留具体页码）
- 存储：localStorage `eva.task.weekly-template.v1`（JSON）
- 应用：周复盘结束后，「确认并创建」时可选择「从模板生成」或「从 AI 建议生成」
- 模板与循环任务互补：循环任务是「每天雷打不动的」（如每日英语单词），模板是「本周计划的批量生成」

#### 4.14.2 无感留痕与后台聚合（维度②）

**核心原则**：周一到周六，用户不需要写任何总结。系统后台静默聚合以下数据：

| 数据源 | 自动采集方式 | 存储位置 |
|--------|----------------|----------|
| 任务勾选状态 | Checkbox 点击即落库 | SQLite `tasks` |
| 番茄钟时长 | 计时结束自动写入 | SQLite `focus_sessions` |
| 科目归属 | 任务标签自动识别（如 `#数学`、`#408-DS`） | 任务 tag 字段 |
| 哪几天没完成 | 查询当天任务完成率 = 0% 的日期 | 查询时计算 |
| 每日留痕 | 「一键留痕」生成的 Blog 文章 | 文件系统 `Logs/` |

用户唯一的主动操作：晚上点一下「一键留痕」——已在 v1.0.2 中优化为自动拉取真实数据生成结构化日志，无需手写。

#### 4.14.3 周日终极复盘——MAGI 战术级周报（维度③）

**入口**：新增 `/weekly-review` 路由（亦可从 Dashboard 横幅直达）。

**Step 1 — 数据大盘自动生成（自动，0 分钟）**：

打开页面时调用 `get_weekly_stats`，一次拿齐所有数据，用户不需要输入任何内容。

| 数据源 | 自动采集指标 |
|--------|----------------|
| Tasks | 各科完成率、未完成任务清单、P1 拖延项 |
| Focus Sessions | 每日专注时长、科目时间分配、总小时数 |
| Blog/Logs | 本周留痕数（是否每天都记了）+ 每日 AI 留痕结论 |
| Mood | 同步率趋势（心情波动检测） |

**Step 2 — 可视化图表区（阅读，3 分钟）**：

引入 **Recharts** 轻量级图表库（React 生态原生、树摇友好、体积 ~45KB gzip）。

| 图表 | 类型 | 数据源 |
|------|------|--------|
| 科目精力雷达图 | `<RadarChart>` | `subjectHours` — 各科目时间占比 |
| 每日专注时长柱状图 | `<BarChart>` | `dailyFocus[Mon–Sat]` |
| 任务完成率趋势折线 | `<LineChart>` | `completionByDay` |
| 与上周对比卡片 | 数字 + ↑/↓ 箭头 | `prevWeekComparison` |

**Step 3 — AI 周度战略推演（一键生成，5 分钟阅读）**：

点击「🎯 MAGI 战略推演」按钮，系统将 6 天底层数据（含每日 AI 留痕结论）打包发给大模型。

**专属周复盘 System Prompt**：

```
你现在是考研指挥官。这是学员过去一周的作战数据：
[weeklyStats JSON 注入]
另附每日 AI 留痕结论：
[周一留痕摘要... 周六留痕摘要...]

请给出极度理性的周度评价，严格按以下结构输出：

## 🎯 本周战略结论
(一句话总结本周核心表现)

## ⚠️ 战略偏移点
(哪个科目投入不足，用数据说话)

## 🚨 伪勤奋警告
(耗时长但产出低的部分，如专注 X 小时但完成率仅 Y%)

## 🛡️ 下周战术重心
(3 条可执行的具体行动，动词开头)

不需要废话，直接给出结论。
```

- 输出采用流式打字机渲染（复用 Notes AI 的 Markdown 流式组件）
- 标红薄弱环节，拒绝泛泛鼓励
- 温度 0.3（比日复盘更冷酷）

**Step 4 — 下周计划（AI 建议 + 手动微调，5 分钟）**：
- AI 基于薄弱科目 + 未完成任务自动生成下周任务分配建议
- 用户可选择「从 AI 建议生成」或「从周模板生成」
- 展示为 Tasks 周视图（Mon–Sat 六列），用户可拖拽调整
- 循环任务（daily/weekly）自动填充，不重复创建
- 点击「确认并创建」→ 任务自动分配到各天
- 「下周誓言」文本框（可选）：用户自己写一句话承诺，一并存入复盘文章

**Step 5 — 保存发布（1 分钟）**：
- 一键保存：复盘内容存为 Blog 文章（标题自动为「第N周 复盘」）
- 下周任务自动创建到 Tasks
- 关闭复盘页，回到 Dashboard，闭环完成

#### 4.14.4 Tasks 周视图

**布局**：

```
┌───── 周一 ─────┬───── 周二 ─────┬─ ... ─┬───── 周六 ─────┐
│  ☐ 数学竇一 Ch3  │  ☒ 408-DS 树   │       │  ☐ 政治背诵     │
│  ☒ 英语阅读 x2   │  ☐ 英语单词     │       │  ☐ 模拟卷         │
│  (3/5 done)       │  (1/4 done)       │       │  (0/3 done)       │
└─────────────────┴─────────────────┴───────┴─────────────────┘
```

**交互**：
- Tasks 页新增「周」视图切换（与现有日/时间线/日历/甘特图并列）
- 每列显示当天任务卡片 + 完成率小进度条
- 支持任务在列间拖拽（调整日期）
- 编辑模式：点击某天空白区域快速添加任务
- 周切换：左右箭头切换前后周

#### 4.14.5 Dashboard 周日模式

- 周日时 Dashboard 顶部自动出现釉缸风格横幅：
  - 「本周任务完成 72% · 专注 38.5h · 点击开始复盘」
  - 非周日此横幅收缩为小卡片（「本周进度 72%」），可手动展开
- 点击横幅 → 跳转到 `/weekly-review` 周复盘页

#### 4.14.6 日常执行极简化（Mon–Sat）

每天只需 3 步：
1. **打卡**：进入系统自动签到
2. **执行**：番茄钟 + 勾选任务
3. **留痕**：晚上点一下「一键留痕」自动生成当日日志（拉取真实任务/专注数据）

不做每日复盘——认知负担全部攻到周日统一释放。

#### 4.14.7 数据聚合 API

**新增 Tauri 命令**：

```
get_weekly_stats(week_start: String) -> WeeklyStats
```

**返回结构**：

```typescript
interface WeeklyStats {
  weekStart: string;           // ISO 周一日期
  dailyFocus: number[];        // [Mon, Tue, ..., Sat] 各天专注分钟数
  subjectHours: Record<string, number>; // 科目 → 总小时
  tasksDone: number;
  tasksTotal: number;
  tasksByDay: { date: string; done: number; total: number }[];  // 每天完成率
  completionBySubject: Record<string, { done: number; total: number }>;
  unfinishedTasks: { id: string; title: string; date: string; priority: string }[];  // 未完成任务清单
  logsWritten: number;         // 本周写了几篇留痕
  logSummaries: string[];      // 每日 AI 留痕结论摘要（用于注入周复盘 Prompt）
  avgMood: number;             // 同步率均值
  prevWeekComparison: {        // 与上周对比
    focusDelta: number;        // +/- 分钟
    completionDelta: number;   // +/- 百分比
  };
}
```

**HTTP 桥接**：`GET /api/weekly-stats?week_start=2026-02-23`（Web 端复盘亦可用）

**前端聚合逻辑**：周复盘页打开时调用此接口，一次拿齐所有数据，前端纯渲染。

#### 4.14.8 技术选型

| 组件 | 选型 | 理由 |
|------|------|------|
| 图表库 | **Recharts** (`recharts@2`) | React 原生、声明式 API、树摇友好 ~45KB gzip、社区活跃 |
| 拖拽 | `@dnd-kit/core` + `@dnd-kit/sortable` | 已在 Notes 中使用，复用零成本 |
| 流式 Markdown | 复用 Notes AI 的 `ReactMarkdown` + `remark-gfm` 组件 | 零新增依赖 |
| 周模板存储 | localStorage `eva.task.weekly-template.v1` | 轻量、无需 schema 迁移 |

---

## 5. 开发路线图

### 总览时间线

```
Phase 1: 桎代码补全         (Week 1-2)     ✅ Done
Phase 2: 练功房 + AI 生成   (Week 3-4)     ✅ Done (基础闭环)
Phase 3: 局域网共享         (Week 5-6)     ✅ Done
Phase 4: 智能辅助 + 考研目标 (Week 7-8)     ✅ Done (部分)
Phase 5: 缓存清理 + 打磨    (Week 9)      ✅ Done
Phase 5.5: 响应式 + 双向同步 (Week 9.5)   ✅ Done
Phase 6: 周复盘闭环 + 周计划 (Week 10-11)  🟡 Next
Phase 7: 测试 + 打包发布    (Week 12)
Phase ∞: 远期规划          (练功房深度 / Tailscale)
```

---

### Phase 1: 桩代码补全 · Week 1–2

**目标**：把已经有 UI 但逻辑为空的功能逐一补齐，消除所有 🟡 标记。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Notes 搜索框绑定过滤逻辑 | P1 | 0.5d | §4.7 |
| Notes 树 "刷新" 按钮 + 磁盘扫描命令 | P1 | 1d | §4.7 |
| Resources 列表持久化 → SQLite `resources` 表 | P1 | 1.5d | §4.6 |
| Resources 搜索框绑定过滤逻辑 | P2 | 0.5d | §4.6 |
| Resources 下载按钮 → `openPath` | P2 | 0.5d | §4.6 |
| Resources 文件夹递归上传 | P2 | 1d | §4.6 |
| 删除 `daily_logs` 空表建表语句 | P3 | 0.1d | §4.9 |
| Settings sync 标签页骨架 UI | P2 | 0.5d | §4.8 |
| Settings exam 标签页骨架 UI | P2 | 0.5d | §4.8 |
| Settings privacy 标签页骨架 UI | P2 | 0.5d | §4.8 |

**验收标准**：
- ✅ Notes 搜索框输入关键词可实时过滤树节点
- ✅ Resources 刷新后文件列表仍在
- ✅ 三个占位标签页有基础 UI 框架

---

### Phase 2: 练功房 + AI 生成 · Week 3–4

**目标**：把 Quiz 从桩代码提升为可用的刷题系统；增加 AI 生成练习题能力。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| SQLite `questions` 表 + 6 个 Tauri 命令 | P1 | 1.5d | §4.5 |
| Quiz 页面重构：学科切换 + 题目列表 + 答题卡 | P1 | 2d | §4.5 |
| 答题反馈 + 正确率统计面板 | P1 | 1d | §4.5 |
| 错题本视图 | P1 | 1d | §4.5 |
| SM-2 间隔重复算法实现 | P2 | 1d | §4.5 |
| Dashboard 追加"今日待复习"卡片 | P2 | 0.5d | §4.5 |
| AI 意图模式切换条 | P2 | 1d | §4.4.1 |
| AI 生成练习题 → Quiz 入库流程 | P1 | 1.5d | §4.4.2 |
| AI 引用气泡 + 来源跳转 | P3 | 1d | §4.4.4 |
| AI 失败兜底提示 | P3 | 0.5d | §4.4.5 |

**验收标准**：
- ✅ 可手动录题 + AI 生成题目，在 Quiz 页正常答题
- ✅ 答错的题自动进入错题本
- ✅ Dashboard 显示"今日 N 题待复习"
- ✅ AI 对话支持模式切换

---

### Phase 3: 局域网共享与同步 · Week 5–6

**目标**：实现“副屏控制台 + 随身资料库”跨端协同，优先打通任务/番茄钟/知识阅读，不把重度刷题作为移动端主场景。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Rust 集成 Axum HTTP Server | P1 | 2d | §4.1 |
| 扩展 RESTful API（Tasks 增删改查 + Notes/Resources 文件树与文本读取） | P1 | 2d | §4.1 |
| 扩展 `apiBridge.ts`（Tauri invoke ↔ fetch 双模调用覆盖 Tasks/Notes/Resources） | P1 | 1.5d | §4.1 |
| 番茄钟 Web 纯浏览器可运行（独立计时或与桌面端状态同步） | P1 | 1.5d | §4.1 |
| Dashboard 双模降级（移除 Web 端残留 invoke 白屏风险） | P1 | 1d | §4.1 |
| Notes/Resources Web 只读防御性降级（禁用文件管理动作 + 提示文案） | P1 | 1d | §4.1 |
| 设置 sync 标签页：开关 + IP 展示 + 二维码 + PIN 码 | P1 | 1.5d | §4.1 |
| 侧边栏 LAN 状态指示器 | P3 | 0.5d | §4.1 |
| Tailscale 状态检测命令 | P2 | 1d | §4.2 |
| Settings sync 标签页：Tailscale 区域 | P2 | 0.5d | §4.2 |
| 移动端响应式适配 | P2 | 1d | — |

**验收标准**：
- ✅ iPad Safari 输入 `http://192.168.x.x:9527` 可进行任务勾选、查看番茄钟状态并阅读笔记/资源
- ✅ Dashboard 在纯 Web 环境无白屏，核心统计可用或有明确占位降级
- ✅ Notes/Resources 在 Web 环境为稳定只读模式，文件管理按钮禁用且提示清晰
- ✅ 设置页显示局域网地址 + 二维码
- ✅ Tailscale 在线时显示 MagicDNS 地址

---

### Phase 4: 智能辅助 + 考研目标 · Week 7–8

**目标**：让 AI 深入备考流程；建立科目目标体系。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| 每日复盘仪表盘 UI + 数据聚合 | P1 | 2d | §4.10 |
| AI 一句话点评 + 同步率算法 | P2 | 1d | §4.10 |
| 22:00 自动弹窗提醒 | P3 | 0.5d | §4.10 |
| AI 周复盘报告生成 | P2 | 1.5d | §4.4.3 |
| 碎片时间助手 UI + 推荐算法 | P1 | 2d | §4.11 |
| 考研目标设置页 | P1 | 1.5d | §4.12 |
| Dashboard 科目进度区 | P1 | 1.5d | §4.12 |
| 任务按科目分类统计 | P2 | 1d | §4.12 |

**验收标准**：
- ✅ 每天 22:00 弹出复盘卡片，展示完成率 + 时间分配
- ✅ 点"碎片时间 15 分钟"可获得 1-3 条推荐
- ✅ Dashboard 展示四科目进度条

---

### Phase 5: 缓存清理 + 精细打磨 · Week 9

**目标**：完成缓存清理功能；全局 UI 打磨。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Settings privacy 标签页：存储用量面板 | P1 | 1d | §4.3 |
| 分类清理卡片 + localStorage 清除逻辑 | P1 | 1d | §4.3 |
| 一键全部清理 + 危险操作区 | P1 | 0.5d | §4.3 |
| `get_storage_stats` / `get_workspace_size` Tauri 命令 | P1 | 1d | §4.3 |
| 深色模式细节打磨（输入框背景/卡片边框/悬浮态） | P2 | 1d | — |
| 全局过渡动画一致性 | P3 | 0.5d | — |
| 快捷键自定义（settings shortcut 标签页升级） | P3 | 1d | — |
| Notes 全文搜索命令 | P2 | 1d | §4.7 |

**验收标准**：
- ✅ 隐私与安全页展示各存储层占用大小
- ✅ 可逐项或一键清理缓存
- ✅ 深色/浅色模式无视觉瑕疵

---

### Phase 5.5: 响应式 UI 与 WebSocket 双向同步 · Week 9.5

**目标**：完成移动端可用性收口，并实现“多端无刷新双向同步”。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Rust 端集成 `axum-ws`，建立双向通信通道与状态广播中心 | P1 | 1.5d | §4.1 |
| 前端 `apiBridge`/监听层引入 WebSocket 订阅，对接 React 状态 | P1 | 1d | §4.1 |
| Tailwind 横竖屏断点改造：移动端隐藏边栏，优化触控热区 | P1 | 1d | §4.13 |
| 背景图视觉焦点锚定（`80% center`）适配 | P1 | 0.5d | §4.13 |

**验收标准**：
- ✅ 平板端打卡后桌面端任务状态在无刷新的情况下即时更新
- ✅ 桌面端创建/删除任务后平板端列表即时同步
- ✅ 竖屏下底部导航可用且无误触，核心页面均可单手操作
- ✅ 背景主视觉在竖屏裁切时保持可见

---

### Phase 6: 周复盘闭环 + 周计划 · Week 10–11

**目标**：落地「周一到周六专注执行、周日冷酷复盘」全流程。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Rust `get_weekly_stats` 命令 + HTTP 桥接 | P1 | 1.5d | §4.14.7 |
| 引入 Recharts 图表库 + 封装基础图表组件 | P1 | 0.5d | §4.14.8 |
| `/weekly-review` 路由 + Weekly Review 页面骨架 | P1 | 1d | §4.14.3 |
| 周复盘图表区（雷达图 + 柱状图 + 折线 + 对比卡片） | P1 | 2d | §4.14.3 |
| AI MAGI 战略推演 Prompt + 流式输出 | P1 | 1d | §4.14.3 |
| 复盘保存为 Blog 文章（标签 `周复盘`） | P1 | 0.5d | §4.14.3 |
| Dashboard 周日横幅 + 周进度小卡片 | P1 | 1d | §4.14.5 |
| Tasks 周视图（Mon–Sat 六列 + 拖拽） | P1 | 2d | §4.14.4 |
| Tasks 「一键克隆昨日任务」 | P1 | 0.5d | §4.14.1 |
| Tasks 「保存/应用周常规模板」 | P1 | 1d | §4.14.1 |
| AI 下周任务建议 + 一键创建 | P2 | 1.5d | §4.14.3 |
| 未完成任务一键顺延 | P2 | 0.5d | §4.14.4 |
| 「下周誓言」文本框 + 存储 | P3 | 0.5d | §4.14.3 |

**验收标准**：
- ✅ 周日打开 Dashboard 自动出现「开始复盘」横幅
- ✅ `/weekly-review` 页面展示雷达图 + 柱状图 + 折线 + 对比卡片，无需用户输入
- ✅ MAGI 战略推演一键生成，输出战略偏移 + 伪勤奋 + 下周重心
- ✅ 一键保存后复盘出现在 Blog 列表，下周任务自动创建
- ✅ Tasks 周视图可拖拽调整任务日期
- ✅ 「克隆昨日」按钮可在 10 秒内完成每日排计划
- ✅ 周常规模板可保存/应用，周一到周六每日操作时间 < 2 分钟

---

### Phase 7: 测试 + 打包发布 · Week 12

**目标**：端到端测试 + 产出安装包。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| 端到端主流程测试（任务→日志→知识库→周复盘闭环） | P1 | 1.5d | — |
| 局域网共享压力测试（3 台设备同时访问） | P1 | 0.5d | §4.1 |
| Windows MSI/NSIS 安装包构建 | P1 | 0.5d | — |
| 升级提示机制（版本号对比） | P3 | 0.5d | — |
| README 更新 + 使用指南 | P2 | 1d | — |
| 开源协议 + CHANGELOG | P3 | 0.5d | — |

**验收标准**：
- ✅ 安装包可在全新 Windows 10/11 上正常安装运行
- ✅ 首次启动自动创建工作区目录
- ✅ 局域网共享在 iPad/手机上可正常浏览
- ✅ 周复盘闭环全流程顺畅无卡点

---

## 6. 功能来源追溯表

| # | 功能 | 来源 | 章节 |
|---|------|------|------|
| 1 | 局域网共享 | 🔵 用户需求 | §4.1 |
| 2 | 内网穿透 (Tailscale) | 🔵 用户需求 | §4.2 |
| 3 | 缓存清理 | 🔵 用户需求 | §4.3 |
| 4 | AI 生成功能增强 | 🔵 用户需求 | §4.4 |
| 5 | 练功房升级 | 🟡 已设桩未完成 | §4.5 |
| 6 | 资源站持久化与搜索 | 🟢 已实现（生成试卷待补） | §4.6 |
| 7 | 知识库搜索与树同步 | 🟡 已设桩未完成 | §4.7 |
| 8 | 设置占位标签补全 | 🟡 已设桩未完成 | §4.8 |
| 9 | `daily_logs` 空表清理 | 🟢 已实现 | §4.9 |
| 10 | 每日复盘仪表盘 | 🟣 新增规划 | §4.10 |
| 11 | 智能碎片时间助手 | 🟣 新增规划 | §4.11 |
| 12 | 考研科目目标体系 | 🟣 新增规划 | §4.12 |
| **13** | **周复盘工作流与周计划体系** | **🟣 核心新增** | **§4.14** |

---

## 7. 风险与依赖

| 风险 | 影响 | 缓解 |
|------|------|------|
| Axum Server 内存占用 | 桌面端内存压力 | Axum 本身极轻量；设置中可关闭 LAN Server |
| AI API 费用 | 长期使用成本 | 默认使用 DeepSeek（性价比最高）；离线时降级为本地规则 |
| Tailscale 依赖第三方 | 穿透不可控 | 已降优至远期；局域网已足够覆盖 99% 考研场景 |
| SM-2 间隔重复参数调优 | 复习节奏不合理 | 允许用户手动调整间隔；提供"重置复习计划"按钮 |
| 移动端浏览器兼容 | Safari/Chrome 差异 | 使用标准 Web API；测试覆盖 iOS Safari + Android Chrome |
| Recharts 图表包体积 | 打包体积增长 ~45KB | 仅在周复盘页懒加载（`React.lazy`），不影响主包加载速度 |

---

## 8. 指标与成功标准

| 指标 | 目标 |
|------|------|
| 日活打卡率 | > 80% 的使用天打卡签到 |
| 任务完成率 | 周均 > 70% |
| **周复盘完成率** | **> 90% 的周日完成周复盘** |
| **周复盘时间** | **单次复盘操作时间 < 15 分钟** |
| AI 对话使用率 | 每周 > 10 次有意义交互 |
| 每日留痕率 | Mon–Sat > 80% 的天生成日志 |
| 局域网共享 | iPad 端每周 > 5 次访问 |

---

*文档维护：每完成一个 Phase，更新对应章节状态标记 🟡 → 🟢*
