# 考研辅助全栈平台 · PRD & Roadmap v2

> EVA 绫波丽主题 · 本地优先 · 2025-02 更新

---

## 0. 文档说明

本 PRD 是对 v1 版本的全面升级。基于项目当前真实代码审计（33 个 Tauri 命令、8 个页面路由、4 张 SQLite 表），明确区分 **已完成 / 已设桩但未完成 / 全新规划** 三类功能，形成可执行的开发路线图。

**功能来源分类标记**：
- 🟢 **已完成** — 代码与 UI 均已就位，日常可用
- 🟡 **已设桩** — 项目中已有入口 / 占位代码 / 空壳 UI，需补全逻辑
- 🔵 **用户需求** — 用户明确提出的 4 项功能
- 🟣 **新增规划** — 审计后额外设计的 3 项功能

---

## 1. 产品定位与美学

### 1.1 一句话定位

> **一个本地优先、EVA 绫波丽美学的考研辅助个人操作系统，帮助考研人用直觉操作完成每日规划、复盘、知识沉淀与智能问答。**

### 1.2 核心用户画像

| 属性 | 描述 |
|------|------|
| 身份 | 考研备考学生（408 + 数一 + 英一 + 政治） |
| 痛点 | 需要在多科目之间高效切换、精确管理碎片化时间、快速沉淀与回顾知识 |
| 习惯 | 习惯 iPad 看视频、电脑做题复盘，需要多端同步 |
| 审美 | 偏好极简、高级感界面，减少视觉噪音提高专注力 |

### 1.3 设计语言

| 元素 | 规范 |
|------|------|
| 主色调 | 冷白 `#F8FAFC` / 深邃黑 `#0a1120` |
| 点缀色 | 绫波蓝 `#88B5D3`（信息态）· 初号机橙 `#FF9900`（警示/强调） |
| 面板 | 毛玻璃（`backdrop-blur-xl + bg-white/40`） |
| 圆角 | 卡片 `2rem`、按钮 `xl`、输入框 `xl` |
| 动画 | Framer Motion，支持三档：完整 / 减弱 / 关闭 |
| 字体 | 系统字体栈，支持全局缩放（0.8x–1.4x） |

---

## 2. 技术架构概览

```
┌─────────────────────────────────────────────────────┐
│               EVA 考研辅助终端 (Tauri v2)           │
│                                                     │
│  ┌───────────────┐          ┌───────────────────┐   │
│  │  桌面端 UI    │          │  局域网 Web UI    │   │
│  │  (WebView2)   │          │  (平板/手机访问)  │   │
│  └───────┬───────┘          └────────┬──────────┘   │
│          │                           │              │
│          ▼                           ▼              │
│  ┌─────────────────────────────────────────────┐    │
│  │            Rust 核心服务层                   │    │
│  │  33 Tauri Commands + Axum LAN Server        │    │
│  └──────┬──────────┬────────────┬──────────────┘    │
│         │          │            │                    │
│         ▼          ▼            ▼                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────────────┐    │
│  │ 文件系统 │ │  SQLite  │ │ AI 代理 (3家LLM) │    │
│  │ Logs/    │ │ eva.db   │ │ DeepSeek / Kimi  │    │
│  │ Notes/   │ │ 4 tables │ │ / MiniMax        │    │
│  │ Resources│ │          │ │                   │    │
│  └──────────┘ └──────────┘ └──────────────────┘    │
└─────────────────────────────────────────────────────┘
```

**当前存储分布**（详见 [数据存储白皮书](数据存储白皮书.md)）：

| 存储层 | 内容 |
|--------|------|
| **SQLite** (`eva.db`) | `tasks`、`focus_sessions`、`video_bookmarks`、`resources` |
| **文件系统** | `Logs/*.md`（日志）、`Notes/`（知识库）、`Resources/`（资源） |
| **localStorage** | 设置、树缓存、草稿编辑器、AI Key 兼容读取 |

---

## 3. 功能模块现状审计

### 3.1 考研大盘 · Dashboard 🟢

**状态：已完成**

| 功能 | 说明 | 状态 |
|------|------|------|
| 考研倒计时 | 目标日 2026-12-20，精确到天 | 🟢 |
| 签到/签退打卡 | localStorage + SQLite 双写 | 🟢 |
| 番茄钟 | 普通 + 全屏沉浸模式，预设 25/50/5 分钟 + 自定义 | 🟢 |
| 30 天专注热力图 | GitHub 风格，基于 `focus_minutes` 渐变 | 🟢 |
| NERV 数据块 | 连续签到天数、日/周/7日均专注时长 | 🟢 |
| 任务饼图 | todo/in-progress/done 三色 SVG | 🟢 |
| 今日待办清单 | 可直接勾选切换状态 | 🟢 |

**本期不扩展**，后续阶段追加「科目进度大盘」与「艾宾浩斯复习提醒」。

---

### 3.2 任务与计划 · Tasks 🟢

**状态：已完成（功能最丰富的模块）**

| 功能 | 说明 | 状态 |
|------|------|------|
| 待办列表 | 快速添加 + 完整表单 CRUD | 🟢 |
| 一键状态切换 | done ↔ todo | 🟢 |
| 优先级 / 标签 | P1–P4 色标渲染 | 🟢 |
| 日期导航 | 前后日切换 | 🟢 |
| 循环任务 | daily / weekly 自动在新日创建 | 🟢 |
| 一键延期 | +1 天快速顺延 | 🟢 |
| 日历视图 | 月历网格 + 每天任务圆点 | 🟢 |
| 时间线视图 | 垂直时间线 | 🟢 |
| 甘特图 | 日视图 + 周视图横向条形 | 🟢 |
| 每日小结 | 对话框展示 done/total 统计 | 🟢 |
| 单任务番茄钟 | 浮动 + 全屏 | 🟢 |
| Markdown 导入 | 文件选择器 / 粘贴，解析 `- [ ]` 任务项 + `@date` + `#tag` | 🟢 |
| AI 闪电灵感 | 自然语言 → DeepSeek → 结构化任务批量创建 | 🟢 |

---

### 3.3 每日留痕 · Blog 🟢

**状态：已完成**

| 功能 | 说明 | 状态 |
|------|------|------|
| 日志 CRUD | 创建/编辑/删除，标题/标签/内容 | 🟢 |
| 搜索/过滤/排序/分页 | 10 条/页，按标签过滤 | 🟢 |
| Markdown 渲染 | ReactMarkdown + remark-gfm | 🟢 |
| 心情追踪 | happy/sad/neutral/focused + 同步率百分比 | 🟢 |
| 工具栏编辑器 | H1/H2/粗体/斜体/引用/代码/链接 快捷键 | 🟢 |
| AI 日报生成 | 基于当天任务自动生成日报（Kimi → DeepSeek 回退） | 🟢 |
| 草稿自动保存 | localStorage 暂存 | 🟢 |
| 视频时间戳 | `[MM:SS]` 可外部跳转 B 站带时间戳链接 | 🟢 |
| 详情页 | 独立路由 BlogPost 渲染/编辑/删除 | 🟢 |

---

### 3.4 知识库 · Notes 🟢（部分 🟡）

**状态：核心完成，2 处桩代码待补**

| 功能 | 说明 | 状态 |
|------|------|------|
| 树形文件浏览器 | 文件夹/文件图标，可折叠 | 🟢 |
| 文件上传 (dialog) | Tauri dialog → 复制到 Notes/ | 🟢 |
| 文件夹创建 | 磁盘创建 + 树同步 | 🟢 |
| 重命名 / 删除 / 移动 | 单个 + 批量，磁盘操作 + 树同步 | 🟢 |
| 拖拽 | 内部重排 + 外部文件拖入 | 🟢 |
| 多选 | Ctrl+点击 / Shift+范围选 | 🟢 |
| 右键菜单 | 打开/重命名/删除/移动 | 🟢 |
| 预览 | Markdown / 纯文本 / PDF (iframe) | 🟢 |
| AI 多会话聊天 | DeepSeek/Kimi/MiniMax 模型切换，历史记录 | 🟢 |
| 上下文注入 | 勾选文件 → 读取内容 → 作为 AI 上下文 | 🟢 |
| **搜索框** | **UI 已渲染，但 onChange 为空，无过滤逻辑** | 🟡 |
| **树持久化** | **仅 localStorage，不从磁盘反向同步** | 🟡 |

---

### 3.5 资源站 · Resources 🟢（部分 🟡）

**状态：视频书签完整，文件资源持久化缺失**

| 功能 | 说明 | 状态 |
|------|------|------|
| 视频书签 | 输入 BV 号 → Rust 抓取元数据 → SQLite 存储 → 卡片展示 | 🟢 |
| 书签 CRUD | 创建/删除 | 🟢 |
| 外部打开视频 | opener 插件打开浏览器 | 🟢 |
| 学科筛选标签 | 按 subject 过滤 | 🟢 |
| 文件上传 | dialog 选文件 → `copy_files_to_resources` | 🟢 |
| **资源列表持久化** | **已接入 SQLite `resources` 表，页面刷新后可恢复** | 🟢 |
| **搜索框** | **已绑定 onChange，支持按资源名/科目过滤** | 🟢 |
| **下载按钮** | **已接入 `openPath`，可在系统默认应用打开文件** | 🟢 |
| **文件夹上传** | **已支持目录递归拷贝 + 批量入库** | 🟢 |
| **生成试卷** | **仅 `navigate('/quiz?generated=true')`，无实际生成** | 🟡 |

---

### 3.6 练功房 · Quiz 🟡

**状态：几乎全是桩代码，是项目最大的空壳**

| 功能 | 现状 | 目标 |
|------|------|------|
| 学科标签 | UI 渲染但不切换内容 | 按科支持筛选与切换 |
| 题目展示 | 1 道硬编码 AVL 树选择题 | 接入题库 / AI 动态生成 |
| 答题交互 | 选择后可下一题但仅重置 | 完整答题流程 + 正确率统计 |
| 题库 | 完全缺失 | SQLite 存储 + 错题本归档 |
| 间隔重复 | 完全缺失 | 艾宾浩斯提醒算法 |

**详细设计见 §4.5**

---

### 3.7 系统设置 · Settings 🟢（部分 🟡）

**状态：7/10 标签页完成，3 个占位标签**

| 标签页 | 说明 | 状态 |
|--------|------|------|
| 通用 (general) | 开机自启动 (autostart 插件) | 🟢 |
| 外观 (appearance) | 字体缩放、头像 URL、侧边栏背景、动画等级 | 🟢 |
| AI (ai) | DeepSeek / Kimi / MiniMax 三家 API Key | 🟢 |
| 工作区 (workspace) | 文档根目录选择器、在资源管理器中打开 | 🟢 |
| 番茄钟 (pomodoro) | 默认分钟数、铃声、自动全屏 | 🟢 |
| 快捷键 (shortcut) | 静态快捷键列表展示 | 🟢 |
| 关于 (about) | 版本信息 | 🟢 |
| **同步与备份 (sync)** | **`renderPlaceholder(...)` 占位** | 🟡 |
| **考研目标 (exam)** | **`renderPlaceholder(...)` 占位** | 🟡 |
| **隐私与安全 (privacy)** | **`renderPlaceholder(...)` 占位** | 🟡 |

---

### 3.8 后端 Tauri 命令层 🟢

**状态：核心命令已实现，错误处理完备（含 Resources 持久化与递归上传命令）**

| 分组 | 命令数 | 说明 |
|------|--------|------|
| 任务 CRUD | 6 | get/create/update/delete/batch_create + 按日期查询 |
| 日志 CRUD | 4 | .md 文件读写（YAML frontmatter） |
| 专注会话 | 2 | get + upsert |
| 视频书签 | 3 | get/add/delete |
| AI / 外部 API | 2 | `ai_proxy` + `fetch_bilibili_metadata` |
| 工作区 | 3 | initialize + initialize_at + get_root |
| 文件读取 | 3 | read_file_content + get_*_dir |
| 知识库操作 | 8 | copy/batch_copy/delete/batch_delete/move/batch_move/write/create_folder |
| 资源操作 | 5 | get/add/delete + batch_copy_files + batch_copy_folder |
| MD 导入 | 1 | parse_markdown_plan |

**已有空壳**：`main.rs` → `start_lan_server()` 空函数体 + TODO 注释，从未调用。

---

## 4. 新功能详细设计

> 本节覆盖 12 项功能：4 项用户需求 (🔵)、5 项已设桩补全 (🟡→🟢)、3 项新增规划 (🟣)

---

### 4.1 🔵 局域网共享 (LAN Sharing)

**目标**：让 iPad/手机在同一 WiFi 下以浏览器访问桌面端全部数据，实现多端协同复习。

**用户故事**：
> 考研人在书房电脑上录入任务和笔记 → 到图书馆用 iPad 打开局域网地址 → 看到今日任务和笔记 → 在 iPad 上勾选完成的任务 → 回到电脑上数据已同步。

**技术方案**：

| 层级 | 方案 |
|------|------|
| HTTP 框架 | Axum（已在 `main.rs` 中标注推荐） |
| 静态托管 | Vite 打包的 `dist/` 目录 → Axum `ServeDir` |
| 数据 API | 将 33 个 Tauri 命令封装为 RESTful JSON API |
| 端口 | 默认 `0.0.0.0:9527`，可在设置中修改 |
| IP 发现 | 启动后自动检测局域网 IP，在设置 > 同步与备份中展示 |
| 安全 | 可选 PIN 码访问保护（4 位数字，类似 AirDrop） |

**交互设计**：

1. **设置 > 同步与备份** 标签页中：
   - 开关 "启用局域网共享"
   - 显示 `http://192.168.x.x:9527` 地址 + 二维码（QR）
   - 可修改端口号
   - 可设置 4 位 PIN 码
   - 已连接设备列表（IP + 设备 User-Agent）
2. **状态指示器**：侧边栏底部显示 📡 图标 + 连接数
3. **权限分级**：
   - **只读模式**（默认）：查看任务/笔记/日志，不可修改
   - **读写模式**：需输入 PIN 码，可创建/编辑任务和日志

**API 路由规划**（部分）：

```
GET    /api/tasks?date=2026-02-25
POST   /api/tasks
PUT    /api/tasks/:id
DELETE /api/tasks/:id
GET    /api/logs
GET    /api/notes/tree
GET    /api/notes/file?path=xxx
GET    /api/focus
POST   /api/focus
```

---

### 4.2 🔵 内网穿透 (Tailscale)

**目标**：让手机/平板在外网环境也可访问桌面端数据，不依赖公网服务器。

**前置条件**：用户已在桌面端和移动端安装 Tailscale 客户端并加入同一 Tailnet。

**交互设计**：

1. **设置 > 同步与备份** 标签页中（在局域网共享下方）：
   - 展示 Tailscale 连接状态（在线 / 离线 / 未安装）
   - 展示 MagicDNS 地址（如 `eva-desktop.tailnet-xxxx.ts.net:9527`）
   - 展示 100.x.x.x Tailscale IP
   - "一键检测连通性" 按钮（向 Tailscale API 查询设备列表）
   - 外网访问说明卡片（步骤指引 + FAQ）

**技术方案**：

| 组件 | 说明 |
|------|------|
| 检测 | 调用 `tailscale status --json` 解析设备列表和网络状态 |
| 地址 | MagicDNS 或 100.x IP + 局域网共享端口 |
| 安全 | Tailscale 本身基于 WireGuard 加密；ACL 策略建议只授权特定设备 |
| 复用 | 复用局域网共享的 Axum Server，不需额外服务 |

**限制**：本平台不内嵌 Tailscale 运行时，仅做状态检测和地址展示。

---

### 4.3 🔵 缓存清理 (Cache Cleanup)

**目标**：一键清理各类缓存和临时数据，释放空间并解决数据异常，让考研人不必操心技术细节。

**当前缓存分布**（基于 [数据存储白皮书](数据存储白皮书.md) 审计）：

| 缓存类型 | 键 / 位置 | 大小估计 |
|----------|-----------|----------|
| 设置 | `eva.settings.v1` | < 1 KB |
| 任务回退 | `qcb.tasks.v1` | 1–50 KB |
| 专注回退 | `qcb.attendance.v1` | 1–10 KB |
| 博客草稿 | `eva.blog.draft.v1` | 0–5 KB |
| AI Key 兼容 | `eva.ai.api.key` | < 0.1 KB |
| 知识库树 | `evaknowledge-tree` | 1–100 KB |
| 文件内容回退 | `eva.file:*` | 0–500 KB |
| 视频书签 | `eva.video.bookmarks.v1` | 1–10 KB |

**交互设计**：

1. **设置 > 隐私与安全** 标签页中（替代原占位文字）：
   - **存储用量面板**：饼图展示 SQLite / 文件系统 / localStorage 各占多少空间
   - **分类清理卡片**，每张卡片有名称、大小、上次更新时间、清理按钮：
     - 🗑️ 编辑器草稿 — 清理 `eva.blog.draft.v1`
     - 🗑️ 知识库树缓存 — 清理 `evaknowledge-tree`，下次打开知识库页从磁盘重建
     - 🗑️ 文件内容缓存 — 清理所有 `eva.file:*` 键
     - 🗑️ 任务本地回退 — 清理 `qcb.tasks.v1`（提示：如果 SQLite 正常则无需保留）
     - 🗑️ 专注数据回退 — 清理 `qcb.attendance.v1`
     - 🗑️ 视频书签本地回退 — 清理 `eva.video.bookmarks.v1`
   - **一键全部清理** 按钮（弹出确认对话框，列出即将清除的内容）
   - **危险操作区**（红色边框）：
     - 🔴 重置所有设置 — 清理 `eva.settings.v1`，恢复默认值
     - 🔴 清空数据库 — 清除 SQLite 全部表数据（需二次确认 + 输入"确认"文字）

2. **清理后反馈**：显示释放了多少空间，受影响的缓存项数量。

**Tauri 命令扩展**：

```rust
#[tauri::command]
fn get_storage_stats() -> StorageStats { ... }   // 返回各存储层占用

#[tauri::command]
fn clear_sqlite_table(table: String) -> Result<(), String> { ... }

#[tauri::command]
fn get_workspace_size() -> u64 { ... }           // 递归计算文件系统大小
```

---

### 4.4 🔵（部分🟢）AI 生成功能增强

**目标**：以 SiliconFlow OpenAI 兼容接口为主，优先打通 DeepSeek-V3.2 流式能力，让 AI 成为考研复习的"副驾驶"。

**当前状态（2026-02-25）**：
- ✅ Settings 已支持 API Key 持久化与模型选择（默认 `deepseek-ai/DeepSeek-V3.2`）
- ✅ 新增前端统一客户端 `src/utils/aiClient.ts`，支持 SiliconFlow 流式返回
- ✅ 知识库 AI 对话已接入流式打字机渲染（最小连通测试：输入"你好"可返回）
- 🟡 意图模式、题目生成、周复盘等高级能力仍待补齐

**当前已有 AI 能力**（保留不变）：

| 能力 | 位置 | 说明 |
|------|------|------|
| AI 代理 | `lib.rs:ai_proxy` | 透传三家 LLM，支持模型选择 |
| 自然语言 → 任务 | Tasks 页 "闪电灵感" | 文字描述 → 结构化任务批量创建 |
| AI 日报 | Blog 页 "AI 帮我写" | 基于今日任务自动生成日报 |
| 知识库问答 | Notes 页 AI 面板 | 勾选文件 → 注入上下文 → 对话 |

**新增 AI 能力**：

#### 4.4.1 意图模式切换

在 AI 对话输入框上方增加模式切换条：

| 模式 | 系统 Prompt 行为 | 适用场景 |
|------|------------------|----------|
| 📖 总结 | 压缩输入为要点清单 | 读完一章笔记后快速提取重点 |
| 🔍 检索 | 在注入的文件中定位关键段落并引用出处 | 找某个公式 / 定理在哪篇笔记里 |
| ✏️ 生成 | 根据指令创造新内容（题目/大纲/模板） | 生成练习题、周计划模板 |
| 📅 计划 | 输出结构化日/周计划（含日期、科目、时长分配） | "帮我安排下周复习进度" |
| 🔄 复盘 | 分析完成率、找出薄弱环节、给出改进建议 | 每周日回顾本周数据 |

**交互**：默认"总结"模式；切换模式时，系统 Prompt 前缀自动变化，历史记录保留。

#### 4.4.2 AI 生成练习题

用户在知识库勾选若干笔记文件 → 右键或工具栏点击 "生成练习题" → AI 读取文件内容 → 输出结构化的选择题 / 填空题 / 简答题 → 用户确认后写入 Quiz 练功房题库。

**数据结构**：

```typescript
interface Question {
  id: string;
  subject: "408-ds" | "408-cn" | "408-os" | "408-co" | "math" | "english" | "politics";
  type: "choice" | "fill" | "short-answer";
  stem: string;                   // 题干
  options?: string[];             // 选择题选项
  answer: string;                 // 答案
  explanation: string;            // 解析
  source_files: string[];         // 来源笔记路径
  difficulty: 1 | 2 | 3;         // 难度
  created_at: string;
  next_review?: string;           // 下次复习日期（间隔重复）
  review_count: number;           // 复习次数
  correct_count: number;          // 答对次数
}
```

#### 4.4.3 AI 周复盘报告

每周日（或用户手动触发），AI 自动：
1. 读取本周所有 `focus_sessions` 数据
2. 读取本周任务完成率（按科目统计）
3. 读取本周日志的心情趋势
4. 生成一份结构化周报：
   - 科目时间分配饼图（数据由前端基于返回数据渲染）
   - 完成率趋势
   - 薄弱科目预警
   - 下周建议安排

#### 4.4.4 上下文可见性

在 AI 对话回复中，被引用的笔记片段以"引用气泡"展示，点击可跳转到 Notes 页对应文件。让用户清楚 AI 依据了什么资料回答问题。

#### 4.4.5 失败兜底

当知识库中找不到相关资料时，AI 不生硬回答，而是给出：
- "知识库中未找到相关内容"
- "建议补充以下资料：[关键词列表]"
- "是否改为联网搜索？（调用通用模型）"

---

### 4.5 🟡 练功房升级 (Quiz Enhancement)

**现状**：整个 Quiz 页面是项目中最大的桩代码，只有 1 道硬编码 AVL 树选择题。

**目标**：打造一个完整的刷题 + 错题本 + 间隔重复系统。

**功能矩阵**：

| 功能 | 说明 |
|------|------|
| 题库 CRUD | SQLite `questions` 表，支持手动录入 + AI 生成入库 |
| 学科切换 | 顶部标签按科目过滤（408 细分到数据结构/计网/OS/组成原理） |
| 答题模式 | 顺序练习 / 随机抽取 / 错题重做 / 模拟考试（限时 + 随机组卷） |
| 答题反馈 | 选择后即时显示对错 + 解析 + 来源笔记链接 |
| 正确率统计 | 科目维度的正确率面板（总体 / 近 7 天 / 近 30 天） |
| 错题本 | 答错自动归档，可手动标记"已掌握"移出 |
| 间隔重复 | 基于 SM-2 算法（SuperMemo）计算下次复习日期，首页 Dashboard 展示今日待复习题数 |
| AI 出题 | 勾选笔记 → AI 输出 JSON 题目 → 预览 → 确认入库 |

**SQLite 新增表**：

```sql
CREATE TABLE IF NOT EXISTS questions (
    id          TEXT PRIMARY KEY,
    subject     TEXT NOT NULL,
    type        TEXT NOT NULL DEFAULT 'choice',
    stem        TEXT NOT NULL,
    options     TEXT,              -- JSON array
    answer      TEXT NOT NULL,
    explanation TEXT DEFAULT '',
    source_files TEXT DEFAULT '[]', -- JSON array
    difficulty  INTEGER DEFAULT 2,
    created_at  DATETIME DEFAULT CURRENT_TIMESTAMP,
    next_review DATETIME,
    review_count INTEGER DEFAULT 0,
    correct_count INTEGER DEFAULT 0,
    ease_factor REAL DEFAULT 2.5   -- SM-2 算法参数
);
CREATE INDEX idx_questions_subject ON questions(subject);
CREATE INDEX idx_questions_next_review ON questions(next_review);
```

**Tauri 命令扩展**（6 个）：

```
get_questions(subject?, type?, limit?)
create_question(question)
batch_create_questions(questions)
update_question_review(id, is_correct)   // 更新 SM-2 参数
delete_question(id)
get_due_questions(date)                  // 获取今日待复习题
```

---

### 4.6 🟢（部分）资源站持久化与搜索补全

**当前状态（2026-02-25）**：资源持久化、搜索、下载打开、文件夹递归上传均已实现；“生成试卷”能力仍待联动 Quiz 题库。

**修复方案**：

| 修复项 | 方案 |
|--------|------|
| 资源持久化 | 新增 SQLite `resources` 表，记录文件名、路径、科目、大小、上传时间 |
| 搜索框 | 绑定 `onChange`，对资源名 + 科目标签做模糊匹配过滤 |
| 下载按钮 | 调用 `opener::openPath` 在系统文件管理器中定位文件 |
| 文件夹上传 | 使用 `dialog.open({ directory: true })` 选中目录 → Rust 递归遍历 → 批量复制 + 入库 |
| 生成试卷 | 连接 Quiz 练功房，基于勾选的资源内容调用 AI 生成题目 |

**SQLite 新增表**：

```sql
CREATE TABLE IF NOT EXISTS resources (
    id          TEXT PRIMARY KEY,
    name        TEXT NOT NULL,
    path        TEXT NOT NULL,      -- 相对于 Resources/ 的路径
    file_type   TEXT DEFAULT 'file', -- file / folder
    subject     TEXT DEFAULT '',
    size_bytes  INTEGER DEFAULT 0,
    created_at  DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

### 4.7 🟡 知识库搜索与树同步

**现状**：搜索框有 UI 无逻辑；树仅存 localStorage，磁盘外部修改不同步。

**修复方案**：

| 修复项 | 方案 |
|--------|------|
| 搜索 | `onChange` 绑定关键词 → 递归遍历树节点做文件名模糊匹配 → 高亮命中项 + 自动展开父节点 |
| 全文搜索 | 可选：调用 Tauri 命令在 `Notes/` 下 `grep` 文件内容 → 返回匹配片段 + 文件路径 |
| 树同步 | 增加"刷新"按钮：调用 Rust 命令扫描 `Notes/` 磁盘目录 → diff 与 localStorage 树 → 合并 |
| 自动同步 | 页面 mount 时自动检测：对比树节点数 vs 磁盘文件数，若差异 > 5% 则弹提示 |

**Tauri 命令扩展**：

```
scan_notes_directory() -> TreeNode[]           // 递归扫描磁盘目录树
search_notes_content(keyword) -> SearchHit[]   // 全文搜索
```

---

### 4.8 🟡 设置占位标签补全

三个 `renderPlaceholder(...)` 标签页需要用实际功能替代：

| 标签页 | 归属功能 | 内容 |
|--------|----------|------|
| 同步与备份 (sync) | §4.1 局域网共享 + §4.2 内网穿透 | LAN Server 开关、IP/端口/PIN/二维码、Tailscale 状态、连接数 |
| 考研目标 (exam) | §4.12 考研科目目标体系 | 总分目标、各科目标、阶段里程碑、当前进度条 |
| 隐私与安全 (privacy) | §4.3 缓存清理 | 存储用量面板、分类清理、危险操作区 |

---

### 4.9 🟢 `daily_logs` 空表清理

**现状**：`lib.rs` 行 175 创建了 `daily_logs` SQLite 表，但所有日志 CRUD 操作都走 `Logs/*.md` 文件系统。这张表从未被插入或查询。

**结果（2026-02-25）**：已删除建表语句与相关索引。日志继续沿用 YAML frontmatter + Markdown 文件方案。

---

### 4.10 🟣 每日复盘仪表盘 (Daily Review Dashboard)

**设计理念**：考研人最害怕的不是不努力，而是不知道今天够不够努力。用一页仪表盘给出清晰答案。

**入口**：Dashboard 页新增"今日复盘"按钮，或每天 22:00 后自动弹窗提醒。

**面板内容**：

| 区域 | 展示内容 |
|------|----------|
| 🎯 完成率环形图 | 今日任务 done/total，按科目分色 |
| ⏱ 时间数据 | 总专注时长、签到时间、签退时间、番茄钟个数 |
| 📊 科目时间分配 | 水平条形图：每科目花了多少小时 |
| 📝 今日留痕摘要 | 如果有日志，展示第一段；如果没有，引导去写 |
| 🧠 同步率 | 综合评分 = 0.4×完成率 + 0.3×专注时长达标率 + 0.3×日志完成 |
| 💡 AI 一句话点评 | 调用 AI 生成 ≤ 50 字鼓励/建议 |

**操作**：
- "写今日留痕" → 跳转 Blog 编辑器，自动填充日期
- "查看本周趋势" → 跳转周复盘页

---

### 4.11 🟣 智能碎片时间助手 (Smart Break Planner)

**设计理念**：考研人的碎片时间（等公交、排队、课间）常被浪费。用户告诉系统"我有 15 分钟"，系统推荐最值得做的事。

**入口**：Dashboard 或侧边栏快捷入口，一个显眼的 "碎片时间" 按钮。

**交互流程**：

```
用户点击 "碎片时间" → 
  弹出模态框："你现在有多少时间？" 
  选项：5分钟 / 10分钟 / 15分钟 / 30分钟 / 自定义
→ 系统综合以下数据源做推荐：
  1. 今日未完成任务中最高优先级的
  2. 今日到期的间隔重复题目（练功房）
  3. 最近 3 天未复习的笔记
→ 输出推荐卡片（1-3 条），每条带"开始"按钮：
  - "复习 3 道操作系统错题" → 跳转 Quiz，自动筛选
  - "完成任务：整理线代笔记 Chapter 3" → 跳转 Tasks
  - "快速浏览笔记：计网 TCP 三次握手" → 跳转 Notes 并打开文件
```

**推荐算法**（优先级从高到低）：
1. 今日待复习的间隔重复题（距离遗忘曲线最近的）
2. 今日未完成的 P1/P2 任务中预估时长 ≤ 用户可用时间的
3. 近 7 天新增但未复习的笔记
4. 如果都没有 → 推荐 "做 X 分钟番茄钟读 [最近编辑的笔记]"

---

### 4.12 🟣 考研科目目标与进度体系 (Exam Goal Tracker)

**设计理念**：考研是长线战斗，需要把大目标拆到周、月可感知的进度条。

**入口**：设置 > 考研目标标签页（替代占位文字）+ Dashboard 科目进度区。

**设置页功能**：

| 字段 | 说明 | 示例 |
|------|------|------|
| 目标院校 | 文本输入 | "浙江大学 计算机学院" |
| 目标总分 | 数字输入 | 380 |
| 各科目标分 | 4 个数字输入 | 408: 120 / 数一: 130 / 英一: 75 / 政治: 70 |
| 考试日期 | 日期选择器 | 2026-12-20（与 Dashboard 倒计时联动） |
| 阶段里程碑 | 可添加多条，每条含名称+截止日期+描述 | "数学第一轮复习完成 · 2026-04-30" |
| 408 子科目权重 | 4 个百分比滑块 | 数据结构 30% / 计网 25% / OS 25% / 组成原理 20% |

**Dashboard 科目进度区**（新增卡片）：

```
┌──────────────────────────────────────────────┐
│  📊 科目进度                                 │
│                                              │
│  408 ████████░░░░░░░░ 52%  目标 120          │
│    ├ 数据结构  ██████████░░ 80%              │
│    ├ 计算机网络 ████████░░░░ 65%              │
│    ├ 操作系统  ████░░░░░░░░ 35%              │
│    └ 组成原理  ██░░░░░░░░░░ 20%              │
│  数一 ██████░░░░░░░░░░ 40%  目标 130          │
│  英一 ████████████░░░░ 78%  目标 75           │
│  政治 ██░░░░░░░░░░░░░░ 15%  目标 70           │
│                                              │
│  下一里程碑：数学第一轮复习 · 剩余 64 天       │
└──────────────────────────────────────────────┘
```

**进度计算方式**：`科目进度 = 该科目已完成任务数 / 该科目总任务数 × 100%`

依赖：任务标签包含科目名即可自动识别归属，不需要改数据模型。

---

## 5. 开发路线图

### 总览时间线

```
Phase 1: 桩代码补全         (Week 1-2)
Phase 2: 练功房 + AI 生成   (Week 3-4)
Phase 3: 局域网共享 + 穿透  (Week 5-6)
Phase 4: 智能辅助 + 考研目标 (Week 7-8)
Phase 5: 缓存清理 + 打磨    (Week 9)
Phase 6: 测试 + 打包发布    (Week 10)
```

---

### Phase 1: 桩代码补全 · Week 1–2

**目标**：把已经有 UI 但逻辑为空的功能逐一补齐，消除所有 🟡 标记。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Notes 搜索框绑定过滤逻辑 | P1 | 0.5d | §4.7 |
| Notes 树 "刷新" 按钮 + 磁盘扫描命令 | P1 | 1d | §4.7 |
| Resources 列表持久化 → SQLite `resources` 表 | P1 | 1.5d | §4.6 |
| Resources 搜索框绑定过滤逻辑 | P2 | 0.5d | §4.6 |
| Resources 下载按钮 → `openPath` | P2 | 0.5d | §4.6 |
| Resources 文件夹递归上传 | P2 | 1d | §4.6 |
| 删除 `daily_logs` 空表建表语句 | P3 | 0.1d | §4.9 |
| Settings sync 标签页骨架 UI | P2 | 0.5d | §4.8 |
| Settings exam 标签页骨架 UI | P2 | 0.5d | §4.8 |
| Settings privacy 标签页骨架 UI | P2 | 0.5d | §4.8 |

**验收标准**：
- ✅ Notes 搜索框输入关键词可实时过滤树节点
- ✅ Resources 刷新后文件列表仍在
- ✅ 三个占位标签页有基础 UI 框架

---

### Phase 2: 练功房 + AI 生成 · Week 3–4

**目标**：把 Quiz 从桩代码提升为可用的刷题系统；增加 AI 生成练习题能力。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| SQLite `questions` 表 + 6 个 Tauri 命令 | P1 | 1.5d | §4.5 |
| Quiz 页面重构：学科切换 + 题目列表 + 答题卡 | P1 | 2d | §4.5 |
| 答题反馈 + 正确率统计面板 | P1 | 1d | §4.5 |
| 错题本视图 | P1 | 1d | §4.5 |
| SM-2 间隔重复算法实现 | P2 | 1d | §4.5 |
| Dashboard 追加"今日待复习"卡片 | P2 | 0.5d | §4.5 |
| AI 意图模式切换条 | P2 | 1d | §4.4.1 |
| AI 生成练习题 → Quiz 入库流程 | P1 | 1.5d | §4.4.2 |
| AI 引用气泡 + 来源跳转 | P3 | 1d | §4.4.4 |
| AI 失败兜底提示 | P3 | 0.5d | §4.4.5 |

**验收标准**：
- ✅ 可手动录题 + AI 生成题目，在 Quiz 页正常答题
- ✅ 答错的题自动进入错题本
- ✅ Dashboard 显示"今日 N 题待复习"
- ✅ AI 对话支持模式切换

---

### Phase 3: 局域网共享 + 内网穿透 · Week 5–6

**目标**：实现 iPad / 手机通过浏览器访问桌面端数据。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Rust 集成 Axum HTTP Server | P1 | 2d | §4.1 |
| 封装 RESTful API（任务/日志/专注/笔记树） | P1 | 2d | §4.1 |
| 前端 API 层适配（Tauri invoke ↔ fetch 自动切换） | P1 | 1.5d | §4.1 |
| 设置 sync 标签页：开关 + IP 展示 + 二维码 + PIN 码 | P1 | 1.5d | §4.1 |
| 侧边栏 LAN 状态指示器 | P3 | 0.5d | §4.1 |
| Tailscale 状态检测命令 | P2 | 1d | §4.2 |
| Settings sync 标签页：Tailscale 区域 | P2 | 0.5d | §4.2 |
| 移动端响应式适配 | P2 | 1d | — |

**验收标准**：
- ✅ iPad Safari 输入 `http://192.168.x.x:9527` 可看到任务列表和笔记
- ✅ 设置页显示局域网地址 + 二维码
- ✅ Tailscale 在线时显示 MagicDNS 地址

---

### Phase 4: 智能辅助 + 考研目标 · Week 7–8

**目标**：让 AI 深入备考流程；建立科目目标体系。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| 每日复盘仪表盘 UI + 数据聚合 | P1 | 2d | §4.10 |
| AI 一句话点评 + 同步率算法 | P2 | 1d | §4.10 |
| 22:00 自动弹窗提醒 | P3 | 0.5d | §4.10 |
| AI 周复盘报告生成 | P2 | 1.5d | §4.4.3 |
| 碎片时间助手 UI + 推荐算法 | P1 | 2d | §4.11 |
| 考研目标设置页 | P1 | 1.5d | §4.12 |
| Dashboard 科目进度区 | P1 | 1.5d | §4.12 |
| 任务按科目分类统计 | P2 | 1d | §4.12 |

**验收标准**：
- ✅ 每天 22:00 弹出复盘卡片，展示完成率 + 时间分配
- ✅ 点"碎片时间 15 分钟"可获得 1-3 条推荐
- ✅ Dashboard 展示四科目进度条

---

### Phase 5: 缓存清理 + 精细打磨 · Week 9

**目标**：完成缓存清理功能；全局 UI 打磨。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| Settings privacy 标签页：存储用量面板 | P1 | 1d | §4.3 |
| 分类清理卡片 + localStorage 清除逻辑 | P1 | 1d | §4.3 |
| 一键全部清理 + 危险操作区 | P1 | 0.5d | §4.3 |
| `get_storage_stats` / `get_workspace_size` Tauri 命令 | P1 | 1d | §4.3 |
| 深色模式细节打磨（输入框背景/卡片边框/悬浮态） | P2 | 1d | — |
| 全局过渡动画一致性 | P3 | 0.5d | — |
| 快捷键自定义（settings shortcut 标签页升级） | P3 | 1d | — |
| Notes 全文搜索命令 | P2 | 1d | §4.7 |

**验收标准**：
- ✅ 隐私与安全页展示各存储层占用大小
- ✅ 可逐项或一键清理缓存
- ✅ 深色/浅色模式无视觉瑕疵

---

### Phase 6: 测试 + 打包发布 · Week 10

**目标**：端到端测试 + 产出安装包。

| 任务 | 优先级 | 预估 | 关联 |
|------|--------|------|------|
| 端到端主流程测试（任务→日志→知识库→练功房→复盘） | P1 | 1.5d | — |
| 局域网共享压力测试（3 台设备同时访问） | P1 | 0.5d | §4.1 |
| Windows MSI/NSIS 安装包构建 | P1 | 0.5d | — |
| 升级提示机制（版本号对比） | P3 | 0.5d | — |
| README 更新 + 使用指南 | P2 | 1d | — |
| 开源协议 + CHANGELOG | P3 | 0.5d | — |

**验收标准**：
- ✅ 安装包可在全新 Windows 10/11 上正常安装运行
- ✅ 首次启动自动创建工作区目录
- ✅ 局域网共享在 iPad/手机上可正常浏览

---

## 6. 功能来源追溯表

| # | 功能 | 来源 | 章节 |
|---|------|------|------|
| 1 | 局域网共享 | 🔵 用户需求 | §4.1 |
| 2 | 内网穿透 (Tailscale) | 🔵 用户需求 | §4.2 |
| 3 | 缓存清理 | 🔵 用户需求 | §4.3 |
| 4 | AI 生成功能增强 | 🔵 用户需求 | §4.4 |
| 5 | 练功房升级 | 🟡 已设桩未完成 | §4.5 |
| 6 | 资源站持久化与搜索 | 🟢 已实现（生成试卷待补） | §4.6 |
| 7 | 知识库搜索与树同步 | 🟡 已设桩未完成 | §4.7 |
| 8 | 设置占位标签补全 | 🟡 已设桩未完成 | §4.8 |
| 9 | `daily_logs` 空表清理 | 🟢 已实现 | §4.9 |
| 10 | 每日复盘仪表盘 | 🟣 新增规划 | §4.10 |
| 11 | 智能碎片时间助手 | 🟣 新增规划 | §4.11 |
| 12 | 考研科目目标体系 | 🟣 新增规划 | §4.12 |

---

## 7. 风险与依赖

| 风险 | 影响 | 缓解 |
|------|------|------|
| Axum Server 内存占用 | 桌面端内存压力 | Axum 本身极轻量；设置中可关闭 LAN Server |
| AI API 费用 | 长期使用成本 | 默认使用 DeepSeek（性价比最高）；离线时降级为本地规则 |
| Tailscale 依赖第三方 | 穿透不可控 | 仅做状态展示，不内嵌运行时；明确告知用户自行安装 |
| SM-2 间隔重复参数调优 | 复习节奏不合理 | 允许用户手动调整间隔；提供"重置复习计划"按钮 |
| 移动端浏览器兼容 | Safari/Chrome 差异 | 使用标准 Web API；测试覆盖 iOS Safari + Android Chrome |

---

## 8. 指标与成功标准

| 指标 | 目标 |
|------|------|
| 日活打卡率 | > 80% 的使用天打卡签到 |
| 任务完成率 | 周均 > 70% |
| 练功房每周做题 | > 50 题 |
| AI 对话使用率 | 每周 > 10 次有意义交互 |
| 碎片时间使用 | 每周 > 3 次点击"碎片时间"推荐 |
| 局域网共享 | iPad 端每周 > 5 次访问 |

---

*文档维护：每完成一个 Phase，更新对应章节状态标记 🟡 → 🟢*
